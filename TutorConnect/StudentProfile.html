<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TutorConnect - My Dashboard</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #558cdd; /* Teal 400 */
            --primary-dark: #2da79c;  /* Teal 600 */
            --secondary-color: #f472b6; /* Pink 400 */
            --background-start: #f0fdfa; /* Teal 50 */
            --background-end: #fce7f3;   /* Pink 50 */
            --text-primary: #1f2937;     /* Gray 800 */
            --text-secondary: #4b5563;   /* Gray 600 */
            --card-bg: rgba(255, 255, 255, 0.65); /* Enhanced Glassmorphism background */
            --border-color: rgba(255, 255, 255, 0.4);
            --shadow-sm: 0 4px 6px rgba(0, 0, 0, 0.03);
            --shadow-md: 0 10px 15px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 25px 50px rgba(0, 0, 0, 0.1);
            --border-radius: 1.5rem; /* 24px */
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--background-start), var(--background-end));
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            color: var(--text-primary);
            font-weight: 700;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        /* Header */
        .main-header {
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            padding: 1.25rem 0;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid var(--border-color);
        }
        .nav-container { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.75rem; font-weight: 800; color: var(--primary-dark); text-decoration: none; transition: transform 0.3s ease; }
        .logo:hover { transform: scale(1.05); }
        .logo-icon-bg { background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); padding: 0.75rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; color: white; box-shadow: var(--shadow-md); }

        /* Button Styles */
        .btn { 
            padding: 0.8rem 1.75rem; 
            border-radius: 9999px; 
            text-decoration: none; 
            font-family: 'Poppins', sans-serif; 
            font-weight: 600; 
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 0.5rem; 
            border: 1px solid transparent; 
            cursor: pointer; 
        }
        .btn-primary { 
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color)); 
            color: white; 
            box-shadow: var(--shadow-md); 
        }
        .btn-primary:hover { 
            box-shadow: var(--shadow-lg); 
            transform: translateY(-4px) scale(1.02); 
        }
        
        .btn-danger { 
            background-color: rgba(254, 226, 226, 0.7); 
            color: #ef4444; 
            border-color: rgba(252, 165, 165, 0.5); 
        }
        .btn-danger:hover { 
            background-color: rgba(254, 202, 202, 0.9); 
            color: #b91c1c; 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-md); 
        }
        
        .btn-secondary { 
            background-color: rgba(255, 255, 255, 0.7); 
            color: var(--text-secondary); 
            border-color: rgba(229, 231, 235, 0.8);
        }
        .btn-secondary:hover { 
            background-color: white; 
            transform: translateY(-2px); 
            box-shadow: var(--shadow-md); 
        }

        /* Glassmorphism Card Widget */
        .content-card {
            background-color: var(--card-bg);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border-radius: var(--border-radius);
            padding: 2rem 2.5rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        .content-card:hover {
            box-shadow: 0 30px 60px rgba(0,0,0,0.12);
            transform: translateY(-5px);
        }
        
        /* Form Input Styles */
        .input-style {
            background: rgba(255, 255, 255, 0.4) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            border-radius: 0.75rem !important;
            padding: 0.85rem 1.25rem !important;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }
        .input-style::placeholder { color: var(--text-secondary); }
        .input-style:focus {
            border-color: var(--primary-color) !important;
            box-shadow: 0 0 0 4px rgba(45, 212, 191, 0.4);
            background: rgba(255, 255, 255, 0.7) !important;
        }
        
        /* Modal Styles */
        #alert-modal { display: none; }
        #alert-modal.show { display: flex; }
        #alert-modal .content-card {
            background-color: rgba(255, 255, 255, 0.85);
            transform: translateY(0);
        }
        #alert-modal .content-card:hover {
             transform: translateY(0);
        }

        /* MODIFIED: New styles for beautification */
        .detail-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .detail-item .icon-wrapper {
            background-color: rgba(45, 212, 191, 0.15);
            color: var(--primary-dark);
            padding: 0.75rem;
            border-radius: 0.75rem;
            flex-shrink: 0;
        }
        .detail-item .label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }
        .detail-item .value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        .request-item-hover:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-md);
            border-color: white;
        }
    </style>
</head>
<body class="flex flex-col">

    <header class="main-header animate__animated animate__fadeInDown animate__faster">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <div class="logo-icon-bg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>
                </div>
                <span>TutorConnect</span>
            </a>
            <div class="header-actions">
                <a href="Findt.html" class="btn btn-primary">🎓 Find Tutors</a>
            </div>
        </div>
    </header>

    <main class="container py-12 flex-grow">
        <div id="profile-view">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 animate__animated animate__fadeIn">
                <div class="flex items-center gap-6">
                    <img id="header-avatar" src="https://placehold.co/80x80/2dd4bf/FFFFFF/png?text=S" class="w-20 h-20 rounded-full object-cover border-4 border-white shadow-lg">
                    <div>
                        <h1 id="profile-student-name" class="text-4xl lg:text-5xl font-extrabold text-slate-800">Loading...</h1>
                        <p id="profile-student-email" class="text-lg text-slate-500 mt-1">loading@email.com</p>
                    </div>
                </div>
                <div class="profile-actions flex gap-4 mt-6 md:mt-0 self-end md:self-center">
                    <button id="edit-profile-btn" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        <span>Edit Profile</span>
                    </button>
                    <button id="sign-out-btn" class="btn btn-danger">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>
                        <span>Sign Out</span>
                    </button>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-2 gap-8 mt-6">
                <div class="content-card animate__animated animate__fadeInUp">
                    <h3 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-primary-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        About Me
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-8">
                        <div class="detail-item">
                            <div class="icon-wrapper">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                            </div>
                            <div>
                                <p class="label">Hometown</p>
                                <p id="view-hometown" class="value">Loading...</p>
                            </div>
                        </div>
                         <div class="detail-item">
                            <div class="icon-wrapper">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                            </div>
                            <div>
                                <p class="label">Grade / Level</p>
                                <p id="view-student-grade" class="value">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-card animate__animated animate__fadeInUp" style="animation-delay: 100ms;">
                    <h3 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-primary-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>
                        Learning Preferences
                    </h3>
                    <div class="space-y-8">
                        <div class="detail-item">
                             <div class="icon-wrapper">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 4v12l-4-2-4 2V4M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                            </div>
                            <div>
                                <p class="label">Subjects of Interest</p>
                                <p id="view-student-subject" class="value">Loading...</p>
                            </div>
                        </div>
                        <div class="detail-item">
                             <div class="icon-wrapper">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                            </div>
                            <div>
                                <p class="label">Nearby Towns for Tutoring</p>
                                <p id="view-nearby-towns" class="value">Loading...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="content-card mt-8 animate__animated animate__fadeInUp" style="animation-delay: 200ms;">
                <h3 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-primary-dark" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    My Booking Requests
                </h3>
                <div id="booking-requests-container" class="space-y-4">
                    <p class="text-slate-500">Loading requests...</p>
                </div>
            </div>

        </div>

        <div id="profile-edit" class="hidden animate__animated animate__fadeIn">
            <h1 class="text-5xl font-extrabold text-slate-800 mb-8">✏️ Edit Your Profile</h1>
            <form id="edit-form" class="space-y-8">
                <div class="content-card p-8 hover:transform-none">
                    <h3 class="text-2xl font-bold text-slate-800 mb-6">Update Details & Preferences</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-6">
                        <div>
                            <label for="student-name" class="block text-sm font-medium text-slate-700 mb-2">Full Name</label>
                            <input type="text" id="student-name" class="mt-1 block w-full input-style">
                        </div>
                        <div>
                            <label for="student-subject" class="block text-sm font-medium text-slate-700 mb-2">Subjects</label>
                            <input type="text" id="student-subject" class="mt-1 block w-full input-style">
                        </div>
                        <div>
                            <label for="student-grade" class="block text-sm font-medium text-slate-700 mb-2">Grade/Level</label>
                            <input type="text" id="student-grade" class="mt-1 block w-full input-style">
                        </div>
                        <div>
                            <label for="hometown" class="block text-sm font-medium text-slate-700 mb-2">Hometown</label>
                            <select id="hometown"></select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="nearby-towns" class="block text-sm font-medium text-slate-700 mb-2">Nearby Towns</label>
                            <select id="nearby-towns" multiple></select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="student-goals" class="block text-sm font-medium text-slate-700 mb-2">Learning Goals</label>
                            <textarea id="student-goals" rows="4" class="mt-1 block w-full input-style"></textarea>
                        </div>
                    </div>
                </div>

                <div class="content-card p-8 hover:transform-none">
                    <h3 class="text-2xl font-bold text-slate-800 mb-6">🔒 Update Password</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="current-password" class="block text-sm font-medium text-slate-700">Current Password</label>
                            <input type="password" id="current-password" class="mt-1 block w-full input-style" placeholder="••••••••">
                        </div>
                        <div>
                            <label for="new-password" class="block text-sm font-medium text-slate-700">New Password</label>
                            <input type="password" id="new-password" class="mt-1 block w-full input-style" placeholder="••••••••">
                        </div>
                        <div>
                            <label for="confirm-password" class="block text-sm font-medium text-slate-700">Confirm New</label>
                            <input type="password" id="confirm-password" class="mt-1 block w-full input-style" placeholder="••••••••">
                        </div>
                    </div>
                    <div class="text-right mt-6">
                        <button type="button" id="change-password-btn" class="btn btn-secondary">Update Password</button>
                    </div>
                </div>
                
                <div class="flex justify-end gap-4 mt-8">
                    <button type="button" id="cancel-edit-btn" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">💾 Save All Changes</button>
                </div>
            </form>
        </div>
    </main>
    
    <div id="alert-modal" class="fixed inset-0 bg-slate-900 bg-opacity-60 flex items-center justify-center h-full w-full z-50 p-4">
        <div class="content-card p-6 border-0 w-full max-w-sm text-center animate__animated animate__zoomIn animate__faster">
            <div id="modal-icon" class="mx-auto flex items-center justify-center h-20 w-20 rounded-full -mt-16 border-4 border-white shadow-lg"></div>
            <h3 id="modal-title" class="text-xl leading-6 font-bold text-slate-900 mt-5"></h3>
            <div class="mt-2 px-4 py-3">
                <p id="modal-message" class="text-sm text-slate-600"></p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="close-modal-btn" class="w-full btn btn-primary">OK</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, reauthenticateWithCredential, EmailAuthProvider, updatePassword, signOut } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBXIlpd17s5xEIyct8PRJVaNNA6QajqGjE",
            authDomain: "tutorconnect-a9b1e.firebaseapp.com",
            projectId: "tutorconnect-a9b1e",
            storageBucket: "tutorconnect-a9b1e.appspot.com",
            messagingSenderId: "511276105084",
            appId: "1:511276105084:web:25dc9ef6fc8c7ce2efb8f9"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const sriLankaTowns = ["Achchuvely", "Adampan", "Addalaichenai", "Adhikarigama", "Adippala", "Agalawatta", "Agaliya", "Agarapathana", "Agbopura", "Ahangama", "Ahungalla", "Akaragama", "Akarawita", "Akarella", "Akkaraipattu", "Akmeemana", "Akuramboda", "Akurana", "Akuressa", "Alahengama", "Alahitiyawa", "Alapaladeniya", "Alawala", "Alawatugoda", "Alawatura", "Alawatuwala", "Alawwa", "Algama", "Allaipiddi", "Alubomulla", "Alutgama", "Alutnuwara", "Aluthwala", "Alvai", "Alwatta", "Ambalangoda", "Ambalantota", "Ambana", "Ambanpola", "Ambewela", "Ampara", "Ampitiya", "Amunakole", "Anaicoddai", "Analaitivu", "Anamaduwa", "Andiambalama", "Andigama", "Angoda", "Angunakolapelessa", "Anguruwatota", "Anhandiya", "Ankokkawala", "Ankumbura", "Anuradhapura", "Apparekka", "Aralaganwila", "Aranayaka", "Arawakumbura", "Aruggammana", "Arugam Bay", "Aselapura", "Atabage", "Atakalanpanna", "Atale", "Ataragalla", "Athurugiriya", "Attanagalla", "Avissawella", "Ayagama", "Ayithiyamalai", "Badalkumbura", "Baddegama", "Badulla", "Baduraliya", "Bakamuna", "Bakiella", "Balagolla", "Balalla", "Balangoda", "Balapitiya", "Bambalapitiya", "Bambarapana", "Bandaragama", "Bandarawela", "Bangadeniya", "Barawakumbuka", "Batapola", "Batawala", "Battaramulla", "Batticaloa", "Batuwatta", "Beliatta", "Belihuloya", "Bellana", "Bellanwila", "Bemmulla", "Bentota", "Beruwala", "Bibile", "Bingiriya", "Biyagama", "Bogawantalawa", "Bokalagama", "Bollete (WP)", "Bope", "Boralesgamuwa", "Borella", "Bothale Ihalagama", "Bowalagama", "Bulathkohupitiya", "Bulathsinhala", "Buttala", "Chankanai", "Chavakachcheri", "Cheddikulam", "Chenkaladi", "Chilaw", "Chunnakam", "Colombo", "Colpetty", "Dambadeniya", "Dambagalla", "Dambana", "Dambulla", "Dankotuwa", "Danowita", "Dedigamuwa", "Deegala Lenama", "Dehiattakandiya", "Dehiowita", "Dehiwala-Mount Lavinia", "Dekatana", "Delgoda", "Dellawa", "Delmella", "Deltara", "Deltota", "Demanhandiya", "Denagama", "Deniyaya", "Deraniyagala", "Devinuwara", "Dharga Town", "Digana", "Dikoya", "Dikwella", "Diyatalawa", "Divulapitiya", "Dodangaslanda", "Doluwa", "Dompe", "Doranagoda", "Dumbara", "Dunagaha", "Eheliyagoda", "Elephant Pass", "Ella", "Elpitiya", "Embilipitiya", "Eppawala", "Eravur", "Etawatunuwewa", "Ethkandura", "Fort", "Galagedara", "Galaha", "Galapitamada", "Galatara", "Galenbindunuwewa", "Galewela", "Galgamuwa", "Galle", "Galnewa", "Galpatha", "Gampaha", "Gampola", "Ganemulla", "Ganga Ihala Korale", "Ganewatta", "Ginigathhena", "Giriulla", "Godagama", "Godakawela", "Gokarella", "Gonagaldeniya", "Gonapinuwala", "Gonawala", "Gothatuwa", "Habarakada", "Habarana", "Hakmana", "Hali-Ela", "Hambantota", "Handapangoda", "Handessa", "Hanguranketha", "Hanwella", "Hapugastalawa", "Haputale", "Harispattuwa", "Hatton", "Havelock Town", "Hendala", "Henegama", "Hettimulla", "Hettipola", "Hewainna", "Hikkaduwa", "Hingula", "Hingurakgoda", "Hingurana", "Hiripitya", "Hiswella", "Hokandara", "Homagama", "Horana", "Horampella", "Horowpathana", "Hulangamuwa", "Hunumulla", "Ibbagamuwa", "Ihala Madampella", "Imaduwa", "Imbulgoda", "Ingiriya", "Inuvil", "Ipalogama", "Ittapana", "Ja-Ela", "Jaffna", "Kadawatha", "Kadugannawa", "Kaduwela", "Kahaduwa", "Kahataruppa", "Kahawatta", "Kalagedihena", "Kalawana", "Kalkudah", "Kalmunai", "Kalpitiya", "Kalutara", "Kamburupitiya", "Kandana", "Kandeketiya", "Kandy", "Kantale", "Kapugoda", "Karadiyanaru", "Karagahatenna", "Karampon", "Karaveddy", "Kataragama", "Kathiraveli", "Kattankudy", "Katugastota", "Katunayake", "Katuneriya", "Katuwana", "Kayts", "Kebithigollewa", "Kegalle", "Kekirawa", "Kelaniya", "Kendagolla", "Kesbewa", "Kilinochchi", "Kinniya", "Kirama", "Kiran", "Kiribathgoda", "Kirinda", "Kiriwattuduwa", "Kirulapone", "Kitulgala", "Kochchikade", "Kodikamam", "Koggala", "Kokkilai", "Kohuwala", "Kokkadicholai", "Kolonnawa", "Kopay", "Kosgama", "Kosgoda", "Koslanda", "Kotagala", "Kotahena", "Kotikawatta", "Kottawa", "Kotte", "Kottegoda", "Kuliyapitiya", "Kundasale", "Kurunegala", "Kuruvita", "Lihiriyagama", "Lindula", "Loluwagoda", "Lunugamvehera", "Lunugala", "Lunugama", "Lunuvila", "Mabole", "Madahapola", "Madampe", "Madapatha", "Madawachchiya", "Madelgamuwa", "Madu Road", "Madulla", "Madulsima", "Mahagama", "Mahakumbukkadawala", "Mahanuwara", "Maharagama", "Mahawa", "Mahawela", "Mahiyanganaya", "Makandura", "Makewita", "Makola", "Malabe", "Mallakam", "Mandapam", "Mandawala", "Mankulam", "Mannar", "Mapalagama", "Maradana", "Marassana", "Marawila", "Maskeliya", "Matale", "Matara", "Mattegoda", "Matugama", "Mawanella", "Mawathagama", "Medawachchiya", "Meddegama", "Medirigiriya", "Meegahatenna", "Meegoda", "Meethirigala", "Melsiripura", "Middeniya", "Mihintale", "Millaniya", "Minuwangoda", "Mirigama", "Mirissa", "Monaragala", "Moragahahena", "Moratuwa", "Morawaka", "Mount Lavinia", "Mullaitivu", "Mulleriyawa New Town", "Mutur", "Mutwal", "Nagoda", "Nakkawatta", "Nalanda", "Nanu Oya", "Napawela", "Narahenpita", "Narammala", "Nattandiya", "Naula", "Nawalapitiya", "Nawana", "Negombo", "Nelliady", "Nikaweratiya", "Nilaveli", "Nildandahinna", "Nittambuwa", "Nochchiyagama", "Norwood", "Nugegoda", "Nuwara Eliya", "Oddamavadi", "Oddusuddan", "Ohiya", "Padaviya", "Padukka", "Paiyagala", "Palavi", "Pallebedda", "Pallekele", "Pallewela", "Pamanugama", "Panadura", "Pannala", "Pannipitiya", "Parakaduwa", "Parakramapura", "Paranthan", "Pasikudah", "Passara", "Pasyala", "Pelawatta", "Peliyagoda", "Pelmadulla", "Peradeniya", "Pettah", "Pilimathalawa", "Piliyandala", "Pitigala", "Point Pedro", "Polgahawela", "Polgasowita", "Polonnaruwa", "Polpithimukulana", "Poruwadanda", "Pottuvil", "Pugoda", "Pujapitiya", "Pulmoddai", "Punakarin", "Pundaluoya", "Pussellawa", "Puttalam", "Puwakpitiya", "Radawana", "Radawadunna", "Raddolugama", "Ragama", "Rajagiriya", "Rakwana", "Ramboda", "Rambukkana", "Ranala", "Ranna", "Rathgama", "Ratmalana", "Ratnapura", "Ridee", "Ruwanwella", "Sainthamaruthu", "Saliyapura", "Samanthurai", "Sandilipay", "Seeduwa", "Serunuwara", "Siddamulla", "Sigiriya", "Silavathurai", "Siyambalanduwa", "Slave Island", "Soranathota", "Sri Jayawardenepura Kotte", "Talaimannar", "Talawatugoda", "Talawakelle", "Tanamalwila", "Tangalle", "Teldeniya", "Tellippalai", "Thambuththegama", "Thanamalvila", "Thavady", "Theldeniya", "Thihagoda", "Thimbirigaskatuwa", "Tirunelveli", "Tissamaharama", "Trincomalee", "Tummodara", "Udagama", "Udappu", "Udathuthiripitiya", "Ududumbara", "Udugampola", "Udugoda", "Udumulla", "Uduvil", "Uggalboda", "Unawatuna", "Undugoda", "Unnichchai", "Uppuveli", "Urumpirai", "Uswetakeiyawa", "Vakaneri", "Valaichenai", "Valvettithurai", "Vavuniya", "Vidataltivu", "Veyangoda", "Wadduwa", "Waga", "Waikkal","Walasmulla", "Warakapola", "Wariyapola", "Watawala", "Watareka", "Wattala", "Wattegama", "Weligama", "Welikanda", "Welimada", "Wellawatta", "Wellawaya", "Wennappuwa","Weeraketiya", "Yakkala", "Yala", "Yatiyantota"].sort();
        const townData = sriLankaTowns.map(town => ({text: town, value: town}));
        
        let hometownSelect, nearbyTownsSelect;

        function initializeSelects() {
            hometownSelect = new SlimSelect({ select: '#hometown', settings: { placeholder: 'Select your hometown' } });
            nearbyTownsSelect = new SlimSelect({ select: '#nearby-towns', settings: { placeholder: 'Select nearby towns' } });
        }

        const ui = {
            profileView: document.getElementById('profile-view'),
            profileEdit: document.getElementById('profile-edit'),
            editBtn: document.getElementById('edit-profile-btn'),
            cancelBtn: document.getElementById('cancel-edit-btn'),
            signOutBtn: document.getElementById('sign-out-btn'),
            editForm: document.getElementById('edit-form'),
            passwordBtn: document.getElementById('change-password-btn'),
            modal: document.getElementById('alert-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalMessage: document.getElementById('modal-message'),
            modalIcon: document.getElementById('modal-icon'),
            closeModalBtn: document.getElementById('close-modal-btn'),
        };

        function showAlert(title, message, isError = false) {
            ui.modalTitle.textContent = title;
            ui.modalMessage.textContent = message;
            ui.modalIcon.className = 'mx-auto flex items-center justify-center h-20 w-20 rounded-full -mt-16 border-4 border-white shadow-lg'; // Reset classes
            if (isError) {
                ui.modalIcon.classList.add('bg-red-100');
                ui.modalIcon.innerHTML = `<svg class="h-10 w-10 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
            } else {
                ui.modalIcon.classList.add('bg-green-100');
                ui.modalIcon.innerHTML = `<svg class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>`;
            }
            ui.modal.classList.add('show');
        }
        ui.closeModalBtn.addEventListener('click', () => ui.modal.classList.remove('show'));

        function getStatusClass(status) {
            switch (status) {
                case 'pending': return 'bg-yellow-100 text-yellow-800';
                case 'accepted': return 'bg-green-100 text-green-800';
                case 'declined': return 'bg-red-100 text-red-800';
                default: return 'bg-slate-100 text-slate-800';
            }
        }

        function renderRequests(requests) {
            const container = document.getElementById('booking-requests-container');
            if (!container) return;

            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <p class="mt-4 text-slate-500">You haven't sent any booking requests yet.</p>
                        <a href="Findt.html" class="btn btn-primary mt-4">Find a Tutor</a>
                    </div>
                `;
                return;
            }

            let html = '';
            requests.forEach(req => {
                const requestDate = req.createdAt ? new Date(req.createdAt.seconds * 1000).toLocaleDateString() : 'N/A';
                const avatarText = req.tutorName ? req.tutorName.split(' ').map(n => n[0]).join('').toUpperCase() : 'TU';
                const profilePic = req.tutorProfilePicUrl || `https://placehold.co/60x60/2dd4bf/ffffff?text=${avatarText}`;
                const statusClass = getStatusClass(req.status);

                html += `
                    <div class="flex items-center justify-between p-4 rounded-xl bg-white/50 border border-slate-200/50 transition-all duration-300 request-item-hover">
                        <div class="flex items-center gap-4">
                            <img src="${profilePic}" alt="${req.tutorName}" class="w-14 h-14 rounded-full object-cover border-2 border-white shadow-sm">
                            <div>
                                <a href="tutor-profile.html?uid=${req.tutorId}" class="font-bold text-slate-800 hover:text-primary-dark transition">${req.tutorName}</a>
                                <p class="text-sm text-slate-600">Subject: <span class="font-medium">${req.subject}</span></p>
                                <p class="text-xs text-slate-500">Requested on: ${requestDate}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-3 py-1 text-sm font-semibold rounded-full ${statusClass}">
                                ${req.status.charAt(0).toUpperCase() + req.status.slice(1)}
                            </span>
                        </div>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        async function fetchAndDisplayRequests(user) {
            const requestsContainer = document.getElementById('booking-requests-container');
            if (!requestsContainer) return;

            try {
                const tutorsCollectionRef = collection(db, "tutors");
                const tutorsSnapshot = await getDocs(tutorsCollectionRef);
                
                let allRequests = [];

                const requestPromises = tutorsSnapshot.docs.map(async (tutorDoc) => {
                    const tutorData = tutorDoc.data();
                    const requestsQuery = query(
                        collection(db, "tutors", tutorDoc.id, "requests"),
                        where("studentUid", "==", user.uid)
                    );
                    const requestsSnapshot = await getDocs(requestsQuery);

                    requestsSnapshot.forEach(requestDoc => {
                        allRequests.push({
                            tutorId: tutorDoc.id,
                            tutorName: tutorData.name,
                            tutorProfilePicUrl: tutorData.profilePicUrl,
                            ...requestDoc.data()
                        });
                    });
                });

                await Promise.all(requestPromises);
                allRequests.sort((a, b) => b.createdAt.seconds - a.createdAt.seconds);
                renderRequests(allRequests);

            } catch (error) {
                console.error("Error fetching booking requests:", error);
                requestsContainer.innerHTML = '<p class="text-red-500">Could not load your booking requests.</p>';
            }
        }

        async function populateProfile(user) {
            const docRef = doc(db, "students", user.uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                const defaultText = 'Not Provided';
                const nearby = data.nearbyTowns && data.nearbyTowns.length > 0 ? data.nearbyTowns.join(', ') : defaultText;
                
                const name = data.name || defaultText;
                const avatarChar = name.charAt(0).toUpperCase();

                // Populate view elements
                document.getElementById('profile-student-name').textContent = `Welcome, ${name}!`;
                document.getElementById('profile-student-email').textContent = `📧 ${data.email || defaultText}`;
                document.getElementById('header-avatar').src = `https://placehold.co/80x80/2dd4bf/FFFFFF/png?text=${avatarChar}`;
                document.getElementById('view-student-subject').textContent = data.subject || defaultText;
                document.getElementById('view-student-grade').textContent = data.grade || defaultText;
                document.getElementById('view-hometown').textContent = data.hometown || defaultText;
                document.getElementById('view-nearby-towns').textContent = nearby;
                
                // Populate edit form
                document.getElementById('student-name').value = data.name || '';
                document.getElementById('student-subject').value = data.subject || '';
                document.getElementById('student-grade').value = data.grade || '';
                document.getElementById('student-goals').value = data.goals || '';
                
                hometownSelect.setData(townData);
                nearbyTownsSelect.setData(townData);

                hometownSelect.setSelected(data.hometown || '');
                nearbyTownsSelect.setSelected(data.nearbyTowns || []);
            } else {
                showAlert("Error", "Could not find your profile data.", true);
            }
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                initializeSelects();
                await populateProfile(user);
                await fetchAndDisplayRequests(user);
            } else {
                window.location.href = "index.html"; // Redirect to a generic landing/login page
            }
        });
        
        function toggleEditMode(showEdit) {
            if(showEdit) {
                ui.profileView.classList.add('hidden');
                ui.profileEdit.classList.remove('hidden');
            } else {
                ui.profileEdit.classList.add('hidden');
                ui.profileView.classList.remove('hidden');
            }
        }

        ui.editBtn.addEventListener('click', () => toggleEditMode(true));
        ui.cancelBtn.addEventListener('click', () => toggleEditMode(false));

        ui.editForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;
            
            const updatedData = {
                name: document.getElementById('student-name').value,
                subject: document.getElementById('student-subject').value,
                grade: document.getElementById('student-grade').value,
                goals: document.getElementById('student-goals').value,
                hometown: hometownSelect.getSelected(),
                nearbyTowns: nearbyTownsSelect.getSelected(),
            };

            try {
                await updateDoc(doc(db, "students", user.uid), updatedData);
                await populateProfile(user);
                toggleEditMode(false);
                showAlert("Success!", "Your profile has been updated.");
            } catch (error) {
                showAlert("Update Error", error.message, true);
            }
        });
        
        ui.passwordBtn.addEventListener('click', async (e) => {
             e.preventDefault();
            const currentPassword = document.getElementById('current-password').value;
            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showAlert("Input Error", "Please fill all password fields.", true);
                return;
            }
            if (newPassword !== confirmPassword) {
                showAlert("Password Error", "New passwords do not match.", true);
                return;
            }
            if (newPassword.length < 6) {
                showAlert("Password Error", "New password must be at least 6 characters.", true);
                return;
            }

            const user = auth.currentUser;
            const credential = EmailAuthProvider.credential(user.email, currentPassword);
            
            try {
                await reauthenticateWithCredential(user, credential);
                await updatePassword(user, newPassword);
                showAlert("Success!", "Your password has been changed successfully.");
                document.getElementById('current-password').value = '';
                document.getElementById('new-password').value = '';
                document.getElementById('confirm-password').value = '';
            } catch (error) {
                let msg = error.code === 'auth/wrong-password' ? "Incorrect current password." : "An error occurred. Please try again later.";
                showAlert("Authentication Error", msg, true);
            }
        });

        ui.signOutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                console.log('User signed out');
                window.location.href = 'index.html'; // Your sign-in page
            }).catch((error) => {
                showAlert("Sign Out Error", error.message, true);
            });
        });

    </script>
</body>
</html>