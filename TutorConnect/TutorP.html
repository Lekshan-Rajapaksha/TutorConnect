<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TutorConnect - Tutor Profile</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            /* Color Palette */
            --p-navy-dark: #0a192f;
            --p-navy-light: #112240;
            --p-slate-light: #ccd6f6;
            --p-slate-dark: #3a4156;
            --p-teal: #64ffda;
            --p-teal-dark: #13a884;
            --p-background: #f0f4f8;
            --p-surface: rgba(255, 255, 255, 0.75);
            --p-border: #dfe6f0;
            
            /* Shadows & Radii */
            --shadow-sm: 0 2px 8px rgba(10, 25, 47, 0.07);
            --shadow-md: 0 6px 15px rgba(10, 25, 47, 0.1);
            --shadow-lg: 0 20px 30px rgba(10, 25, 47, 0.12);
            --shadow-glow: 0 0 15px rgba(100, 255, 218, 0.3);
            --border-radius-md: 1rem;
            --border-radius-lg: 1.5rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--p-background);
            color: var(--p-slate-dark);
            line-height: 1.7; 
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            color: var(--p-navy-dark);
            font-weight: 700;
        }

        .container {
            max-width: 1380px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        /* Header */
        .main-header {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            padding: 1.25rem 0;
            position: sticky;
            top: 0;
            z-index: 50;
            border-bottom: 1px solid var(--p-border);
        }
        .nav-container { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 800; color: var(--p-navy-dark); text-decoration: none; }
        .logo-icon-bg { background: var(--p-navy-dark); padding: 0.6rem; border-radius: 9999px; display: flex; align-items: center; justify-content: center; color: var(--p-teal); }
        
        /* Button */
        .btn { padding: 0.8rem 1.75rem; border-radius: 9999px; text-decoration: none; font-family: 'Poppins', sans-serif; font-weight: 600; transition: all 0.3s ease; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; border: 2px solid transparent; cursor: pointer; }
        .btn-primary { background: var(--p-navy-dark); color: white; }
        .btn-primary:hover { background: var(--p-navy-light); box-shadow: var(--shadow-md); transform: translateY(-3px); }
        .btn-teal { background: var(--p-teal); color: var(--p-navy-dark); box-shadow: var(--shadow-sm); }
        .btn-teal:hover { background: #52e9c8; box-shadow: var(--shadow-glow); transform: translateY(-3px); }
        .btn-outline {
            background-color: transparent;
            border: 2px solid var(--p-teal-dark);
            color: var(--p-teal-dark);
        }
        .btn-outline:hover {
            background-color: var(--p-teal-dark);
            color: var(--p-navy-dark);
        }

        /* Profile Hero */
        .profile-hero {
            padding: 4rem 0 9rem 0;
            background-color: var(--p-navy-dark);
            background-image: linear-gradient(rgba(10, 25, 47, 0.95), rgba(10, 25, 47, 0.95)), url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill-rule='evenodd'%3E%3Cg fill='%23112240' fill-opacity='0.4'%3E%3Cpath opacity='.5' d='M96 95h4v1h-4v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4h-9v4h-1v-4H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15v-9H0v-1h15V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h9V0h1v15h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9h4v1h-4v9zm-1 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-a9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-9-10h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm10 0h9v-9h-9v9zm9-10v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9zm-10 0v-9h-9v9h9z'/%3E%3Cpath d='M6 6h4v4H6V6zm10 0h4v4h-4V6zm10 0h4v4h-4V6zm10 0h4v4h-4V6zm10 0h4v4h-4V6zm10 0h4v4h-4V6zm10 0h4v4h-4V6zm10 0h4v4h-4V6zM6 16h4v4H6v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zM6 26h4v4H6v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zM6 36h4v4H6v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zM6 46h4v4H6v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zM6 56h4v4H6v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zM6 66h4v4H6v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zM6 76h4v4H6v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zM6 86h4v4H6v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4zm10 0h4v4h-4v-4z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            color: var(--p-slate-light);
        }
        .profile-hero-content { display: flex; flex-direction: column; align-items: center; text-align: center; gap: 2rem; }
        @media (min-width: 768px) { .profile-hero-content { flex-direction: row; text-align: left; } }

        .profile-avatar { width: 160px; height: 160px; border-radius: 9999px; object-fit: cover; border: 4px solid white; outline: 4px solid var(--p-teal); box-shadow: var(--shadow-lg); flex-shrink: 0; }
        .profile-name { font-size: 2.75rem; font-weight: 800; line-height: 1.1; color: white; }
        .profile-tagline { font-size: 1.1rem; font-weight: 500; opacity: 0.9; color: var(--p-slate-light); margin-top: 0.5rem; }
        .verified-badge { display: inline-flex; align-items: center; gap: 0.5rem; background: var(--p-teal); color: var(--p-navy-dark); padding: 0.3rem 0.8rem; border-radius: 9999px; font-size: 0.8rem; font-weight: 700; margin-top: 1.25rem; }
        .profile-meta { display: flex; gap: 1.25rem; margin-top: 1.5rem; flex-wrap: wrap; justify-content: center; }
        @media (min-width: 768px) { .profile-meta { justify-content: flex-start; } }
        .profile-meta-item { display: flex; align-items: center; gap: 0.5rem; background: var(--p-navy-light); padding: 0.5rem 1rem; border-radius: 9999px; font-weight: 500; border: 1px solid #233554; }
        .profile-rating-stars { color: #ffac33; }

        /* Main layout */
        .profile-main-layout { display: grid; grid-template-columns: 1fr; gap: 2.5rem; margin-top: -6rem; position: relative; z-index: 10; padding-bottom: 5rem; }
        @media (min-width: 1024px) { .profile-main-layout { grid-template-columns: 1fr 380px; } }

        .content-card { 
            background: var(--p-surface);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg); 
            padding: 2.5rem; 
            box-shadow: var(--shadow-md); 
            border: 1px solid var(--p-border);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .content-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-lg); }
        .content-card h3 { 
            font-size: 1.5rem; 
            margin-bottom: 2rem;
            display: flex; 
            align-items: center; 
            gap: 1rem;
            padding-bottom: 1.25rem;
            border-bottom: 1px solid var(--p-border); 
        }
        .content-card h3 svg { color: var(--p-teal-dark); }
        .prose { font-size: 1.1rem; }
        .prose p:not(:last-child) { margin-bottom: 1.25rem; }

        /* Details section */
        .details-grid { display: grid; grid-template-columns: 1fr; gap: 1.5rem; }
        @media (min-width: 500px) { .details-grid { grid-template-columns: 1fr 1fr; } }
        
        .detail-item-full { grid-column: 1 / -1; }
        .detail-item { 
            background-color: var(--p-background); 
            padding: 1.25rem 1.5rem;
            border-radius: var(--border-radius-md); 
            display: flex; 
            align-items: center; 
            gap: 1.25rem;
            border: 1px solid var(--p-border);
            transition: all 0.3s ease;
        }
        .detail-item:hover { transform: scale(1.02); box-shadow: var(--shadow-sm); border-color: var(--p-teal); }
        .detail-item svg { color: var(--p-teal-dark); flex-shrink: 0; width: 2.5rem; height: 2.5rem; }
        .detail-item strong { color: var(--p-navy-dark); font-weight: 600; display: block; margin-bottom: 0.25rem;}

        .subject-tags-container { display: flex; flex-wrap: wrap; gap: 0.75rem; margin-top: 1rem; }
        .subject-tag { background: var(--p-teal); color: var(--p-navy-dark); padding: 0.4rem 0.9rem; border-radius: 9999px; font-size: 0.85rem; font-weight: 600; }

        /* Reviews section */
        .reviews-container { display: flex; flex-direction: column; gap: 2rem; margin-top: 2rem; }
        .review-card { 
            background-color: #fff;
            border: 1px solid var(--p-border);
            border-radius: var(--border-radius-md); 
            padding: 2rem;
        }
        .review-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .review-avatar { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; background: var(--p-slate-light); color: var(--p-navy-dark); display: flex; align-items: center; justify-content: center; font-weight: 600; font-family: 'Poppins'; flex-shrink: 0; }
        .review-author-info { flex-grow: 1; }
        .review-author { font-weight: 600; color: var(--p-navy-dark); font-size: 1.1rem; }
        .review-date { font-size: 0.875rem; color: var(--p-slate-dark); }
        .review-text { color: var(--p-slate-dark); font-style: italic; position: relative; padding-left: 2.5rem; }
        .review-text::before { content: '“'; font-family: 'Poppins', serif; font-size: 4rem; color: var(--p-teal); position: absolute; left: -0.5rem; top: -0.5rem; line-height: 1; opacity: 0.5; }
        
        .collapsible-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .collapsible-content.open { max-height: 1000px; /* Adjust as needed */ }
        
        #review-form-container {
            background-color: var(--p-background);
            padding: 2rem;
            border-radius: var(--border-radius-md);
            margin-top: 2rem;
        }

        /* Booking Card */
        .booking-card { position: sticky; top: 110px; }
        .booking-card .content-card {
             background: white;
             border: 2px solid transparent;
             background-clip: padding-box;
             position: relative;
        }
        .booking-card .content-card::before {
            content: ''; position: absolute; top: 0; right: 0; bottom: 0; left: 0; z-index: -1;
            margin: -2px; border-radius: inherit; background: linear-gradient(135deg, var(--p-teal), var(--p-teal-dark));
        }
        .price-display { text-align: center; margin-bottom: 1rem; }
        .price-display .amount { font-size: 2.5rem; font-weight: 800; color: var(--p-navy-dark); }
        .price-display .period { font-size: 1rem; font-weight: 500; color: var(--p-slate-dark); }
        .booking-card-description { text-align: center; margin-bottom: 2rem; }
        .booking-card .btn { width: 100%; padding-top: 1rem; padding-bottom: 1rem; font-size: 1.1rem; margin: 0 auto; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(10, 25, 47, 0.7); backdrop-filter: blur(5px); align-items: center; justify-content: center; animation: fadeIn 0.3s forwards; }
        .modal-content {
            background: white;
            margin: auto; padding: 2.5rem; border-radius: var(--border-radius-lg); box-shadow: var(--shadow-lg); width: 90%; max-width: 500px; position: relative; animation: slideInTop 0.3s forwards;
        }
        .modal-content h2 { color: var(--p-navy-dark); text-align: center; margin-bottom: 2rem; }
        .modal-content label, #review-form label { color: var(--p-navy-dark); font-weight: 600; font-size: 0.9rem; margin-bottom: 0.5rem; display: block; }
        .modal-content input, .modal-content textarea, #review-form textarea {
            width: 100%;
            background-color: var(--p-background);
            border: 1px solid var(--p-border);
            color: var(--p-navy-dark);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
        }
        .modal-content input:focus, .modal-content textarea:focus, #review-form textarea:focus {
            outline: none;
            border-color: var(--p-teal-dark);
            box-shadow: 0 0 0 3px rgba(100, 255, 218, 0.5);
        }
        .modal-content .btn, #review-form .btn { width: 100%; margin-top: 1rem; }
        .close-button { color: var(--p-slate-dark); position: absolute; top: 15px; right: 25px; font-size: 28px; font-weight: bold; cursor: pointer; transition: color 0.3s; }
        .close-button:hover { color: var(--p-navy-dark); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideInTop { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Notification Toast */
        #notification-toast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background: var(--p-navy-dark);
            color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; box-shadow: var(--shadow-lg); z-index: 2000; transition: bottom 0.5s ease-in-out;
        }
        #notification-toast.show { bottom: 20px; }

        /* Star Rating Input */
        .star-rating-input { display: flex; flex-direction: row-reverse; justify-content: center; gap: 0.5rem; }
        .star-rating-input input { display: none; }
        .star-rating-input label { font-size: 2.5rem; color: #ccc; cursor: pointer; transition: color 0.2s; }
        .star-rating-input input:checked ~ label,
        .star-rating-input label:hover,
        .star-rating-input label:hover ~ label { color: var(--p-teal-dark); }

    </style>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body>
    <header class="main-header animate__animated animate__fadeInDown">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <div class="logo-icon-bg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>
                </div>
                <span>TutorConnect</span>
            </a>
            <a href="Findt.html" class="btn btn-primary">Find Tutors</a>
        </div>
    </header>

    <div id="tutor-profile-wrapper">
        <!-- Tutor Profile Will Be Rendered Here by JavaScript -->
    </div>
    
    <div id="notification-toast"></div>

    <div id="booking-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-booking-modal">×</span>
            <h2 class="text-2xl font-bold mb-6 text-center">Request a Session with <span id="booking-tutor-name">Tutor</span></h2>
            <form id="booking-form" class="space-y-4">
                <div>
                    <label for="booking-subject">Subject Needed</label>
                    <input type="text" id="booking-subject" name="subject" placeholder="e.g., Calculus, Algebra" required>
                </div>
                <div>
                    <label for="booking-message">Your Message to the Tutor</label>
                    <textarea id="booking-message" name="message" rows="4" placeholder="Hi! I'm interested in getting help with..." required></textarea>
                </div>
                <button type="submit" class="btn btn-teal">Send Request</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, addDoc, getDocs, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXIlpd17s5xEIyct8PRJVaNNA6QajqGjE",
            authDomain: "tutorconnect-a9b1e.firebaseapp.com",
            projectId: "tutorconnect-a9b1e",
            storageBucket: "tutorconnect-a9b1e.appspot.com",
            messagingSenderId: "511276105084",
            appId: "1:511276105084:web:25dc9ef6fc8c7ce2efb8f9",
            measurementId: "G-7M72STVQKP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const tutorProfileWrapper = document.getElementById('tutor-profile-wrapper');
        const bookingModal = document.getElementById('booking-modal');
        const closeBookingModalBtn = document.getElementById('close-booking-modal');
        const bookingTutorName = document.getElementById('booking-tutor-name');
        const bookingForm = document.getElementById('booking-form');
        const notificationToast = document.getElementById('notification-toast');

        let currentTutorUid = null;
        let loggedInUser = null;
        let loggedInStudentName = null;
        let isStudentUser = false;

        function showNotification(message) {
            notificationToast.textContent = message;
            notificationToast.classList.add('show');
            setTimeout(() => { notificationToast.classList.remove('show'); }, 4000);
        }

        function getTutorUidFromUrl() {
            return new URLSearchParams(window.location.search).get('uid');
        }
        
        function getStarRatingHtml(rating) {
            let html = '';
            const fullStars = Math.floor(rating);
            const emptyStars = 5 - fullStars;
            for (let i = 0; i < fullStars; i++) html += '★';
            for (let i = 0; i < emptyStars; i++) html += '☆';
            return html;
        }

        function renderReviews(reviews) {
            if (reviews.length === 0) {
                return '<p class="text-center py-4">This tutor has no reviews yet.</p>';
            }
            return reviews.map(review => {
                const authorInitials = review.studentName ? review.studentName.split(' ').map(n => n[0]).join('').toUpperCase() : '?';
                const reviewDate = review.createdAt ? new Date(review.createdAt.seconds * 1000).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : 'a recent date';

                return `
                <div class="review-card">
                    <div class="review-header">
                        <div class="review-avatar">${authorInitials}</div>
                        <div class="review-author-info">
                            <div class="review-author">${review.studentName || 'Anonymous'}</div>
                            <div class="review-date">Reviewed on ${reviewDate}</div>
                        </div>
                        <div class="profile-rating-stars">${getStarRatingHtml(review.rating)}</div>
                    </div>
                    <p class="review-text">${review.comment}</p>
                </div>
                `;
            }).join('');
        }

        async function renderTutorProfile() {
            currentTutorUid = getTutorUidFromUrl();
            if (!currentTutorUid) {
                tutorProfileWrapper.innerHTML = `<main class="container"><p class="text-center text-red-500 text-lg py-10">Error: Tutor ID not found in URL.</p></main>`;
                return;
            }

            try {
                const tutorDocRef = doc(db, "tutors", currentTutorUid);
                const tutorDocSnap = await getDoc(tutorDocRef);

                if (tutorDocSnap.exists()) {
                    const tutor = { id: tutorDocSnap.id, ...tutorDocSnap.data() };
                    
                    const avatarText = tutor.name ? tutor.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'NA';
                    const subjects = tutor.subject ? tutor.subject.split(',').map(s => s.trim()).filter(s => s) : [];
                    const subjectsHtml = subjects.map(s => `<span class="subject-tag">${s}</span>`).join('');
                    
                    const reviewsCollectionRef = collection(db, "tutors", currentTutorUid, "reviews");
                    const reviewsQuery = query(reviewsCollectionRef, orderBy("createdAt", "desc"));
                    const reviewsSnapshot = await getDocs(reviewsQuery);
                    const tutorReviews = reviewsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    const totalRating = tutorReviews.reduce((sum, review) => sum + review.rating, 0);
                    const averageRating = tutorReviews.length > 0 ? (totalRating / tutorReviews.length) : 0;
                    
                    tutorProfileWrapper.innerHTML = `
                        <div class="profile-hero">
                            <div class="container profile-hero-content animate__animated animate__fadeIn">
                                <img src="${tutor.profilePicUrl || 'https://placehold.co/160x160/64ffda/0a192f?text=' + avatarText}" 
                                     onerror="this.onerror=null;this.src='https://placehold.co/160x160/64ffda/0a192f?text=${avatarText}';"
                                     alt="Tutor ${tutor.name}" class="profile-avatar">
                                <div>
                                    <h1 class="profile-name">${tutor.name}</h1>
                                    <p class="profile-tagline">${tutor.education ? tutor.education.split(';')[0].trim() : 'Dedicated Educator'}</p>
                                    <div class="verified-badge">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z"/></svg>
                                        Verified Tutor
                                    </div>
                                    <div class="profile-meta">
                                        <div class="profile-meta-item"><span class="profile-rating-stars">${getStarRatingHtml(averageRating)}</span>&nbsp;${averageRating.toFixed(1)} (${tutorReviews.length} reviews)</div>
                                        <div class="profile-meta-item">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>
                                            ${tutor.hometown || 'Sri Lanka'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <main class="container">
                            <div class="profile-main-layout">
                                <div class="space-y-10">
                                    <div class="content-card animate__animated animate__fadeInUp" style="animation-delay: 0.1s;">
                                        <h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                                            About Me
                                        </h3>
                                        <div class="prose">
                                            <p>${tutor.about || 'This tutor has not yet provided a biography.'}</p>
                                        </div>
                                    </div>
                                    <div class="content-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                                        <h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                                            Teaching Expertise
                                        </h3>
                                        <div class="space-y-6">
                                            <div class="detail-item detail-item-full">
                                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>
                                                <div>
                                                    <strong>Subjects Taught</strong>
                                                    <div class="subject-tags-container">
                                                        ${subjectsHtml || '<span class="subject-tag">Not specified</span>'}
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="details-grid">
                                                <div class="detail-item">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                    <div><strong>Experience</strong>${tutor.experience || '0'} Years</div>
                                                </div>
                                                <div class="detail-item">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14m-5-4v6m4-2H8m4 0a2 2 0 100-4 2 2 0 000 4zM21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                                    <div><strong>Method</strong>${tutor.method ? tutor.method.charAt(0).toUpperCase() + tutor.method.slice(1) : 'Not specified'}</div>
                                                </div>
                                                <div class="detail-item">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                                                    <div><strong>Availability</strong>${tutor.availability || 'Not specified'}</div>
                                                </div>
                                                <div class="detail-item">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                                                    <div><strong>Contact</strong>${tutor.mobile || 'Not provided'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="content-card animate__animated animate__fadeInUp" style="animation-delay: 0.3s;">
                                        <h3>
                                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21.5 12H16c-.6 0-1 .4-1 1v4c0 .6.4 1 1 1h5.5c.8 0 1.5-.7 1.5-1.5v-3c0-.8-.7-1.5-1.5-1.5z"></path><path d="M8 12h5.5c.8 0 1.5.7 1.5 1.5v3c0 .8-.7 1.5-1.5 1.5H3c-.6 0-1-.4-1 1v-4c0-.6.4-1 1-1h5z"></path><path d="M12 12v8"></path><path d="M5.5 5A3.5 3.5 0 0 1 9 1.5 3.5 3.5 0 0 1 12.5 5c0 1.6-1.4 2.9-3.5 3.5-2.1-.6-3.5-1.9-3.5-3.5z"></path><path d="M18.5 5A3.5 3.5 0 0 0 15 1.5 3.5 3.5 0 0 0 11.5 5c0 1.6 1.4 2.9 3.5 3.5 2.1-.6 3.5-1.9 3.5-3.5z"></path></svg>
                                            What Students Say
                                        </h3>
                                        <button id="toggle-review-form-btn" class="btn btn-outline mb-6">Leave a Review</button>
                                        <div id="review-form-collapsible" class="collapsible-content">
                                            <!-- Review Form will be injected here -->
                                        </div>
                                        <div class="reviews-container">
                                            ${renderReviews(tutorReviews)}
                                        </div>
                                    </div>
                                </div>

                                <div class="booking-card animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                                    <div class="content-card">
                                        <div class="price-display">
                                            <span class="amount">LKR ${tutor.rate || '0'}</span>
                                            <span class="period">per hour</span>
                                        </div>
                                        <p class="booking-card-description">Ready to master your subjects? Send a request to schedule your first session.</p>
                                        <button id="request-session-btn" class="btn btn-teal">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"></path><path d="M16 2v4"></path><path d="M3.5 10h17"></path><path d="M20 21h-2.3a2.7 2.7 0 01-2.6-2.6V10a2 2 0 00-2-2h-3.2a2 2 0 00-2 2v8.4a2.7 2.7 0 01-2.6 2.6H4a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v13a2 2 0 01-2 2z"></path></svg>
                                            Request a Session
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </main>
                    `;

                    bookingTutorName.textContent = tutor.name;
                    attachEventListeners();
                } else {
                    tutorProfileWrapper.innerHTML = `<main class="container"><p class="text-center text-red-500 text-lg py-10">Tutor profile not found.</p></main>`;
                }
            } catch (error) {
                console.error("Error fetching tutor profile:", error);
                tutorProfileWrapper.innerHTML = `<main class="container"><p class="text-center text-red-500 text-lg py-10">Error loading profile: ${error.message}</p></main>`;
            }
        }
        
        function attachEventListeners() {
            const requestSessionBtn = document.getElementById('request-session-btn');
            if (requestSessionBtn) {
                requestSessionBtn.addEventListener('click', () => {
                    if (isStudentUser) {
                        bookingModal.style.display = 'flex';
                    } else {
                        showNotification("Please sign in as a student to request a session.");
                    }
                });
            }

            const toggleReviewFormBtn = document.getElementById('toggle-review-form-btn');
            const reviewFormCollapsible = document.getElementById('review-form-collapsible');

            if(toggleReviewFormBtn && reviewFormCollapsible) {
                toggleReviewFormBtn.addEventListener('click', () => {
                    if (isStudentUser) {
                        const isOpen = reviewFormCollapsible.classList.toggle('open');
                        toggleReviewFormBtn.textContent = isOpen ? 'Hide Review Form' : 'Leave a Review';
                        if (isOpen) {
                            reviewFormCollapsible.innerHTML = `
                                <div id="review-form-container">
                                    <form id="review-form" class="space-y-4">
                                        <div>
                                            <label>Your Rating</label>
                                            <div class="star-rating-input">
                                                <input type="radio" id="star5" name="rating" value="5" required><label for="star5">★</label>
                                                <input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label>
                                                <input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label>
                                                <input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label>
                                                <input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label>
                                            </div>
                                        </div>
                                        <div>
                                            <label for="review-comment">Your Review</label>
                                            <textarea id="review-comment" name="comment" rows="4" placeholder="Share your experience..." required></textarea>
                                        </div>
                                        <button type="submit" class="btn btn-primary">Submit Review</button>
                                    </form>
                                </div>
                            `;
                            attachReviewFormSubmitListener();
                        } else {
                            reviewFormCollapsible.innerHTML = '';
                        }
                    } else {
                        showNotification("Please sign in as a student to leave a review.");
                    }
                });
            }
        }

        function attachReviewFormSubmitListener() {
            const reviewForm = document.getElementById('review-form');
            if(reviewForm) {
                reviewForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(reviewForm);
                    const rating = parseInt(formData.get('rating'));
                    const comment = formData.get('comment').trim();

                    if (!rating || !comment) {
                        showNotification("Please provide a rating and a comment.");
                        return;
                    }

                    const reviewData = {
                        studentUid: loggedInUser.uid,
                        studentName: loggedInStudentName,
                        rating: rating,
                        comment: comment,
                        createdAt: serverTimestamp()
                    };

                    try {
                        const reviewsRef = collection(db, "tutors", currentTutorUid, "reviews");
                        await addDoc(reviewsRef, reviewData);
                        showNotification("Thank you for your review!");
                        document.getElementById('review-form-collapsible').classList.remove('open');
                        document.getElementById('toggle-review-form-btn').textContent = 'Leave a Review';
                        await renderTutorProfile(); // Re-render to show the new review
                    } catch (error) {
                        console.error("Error submitting review: ", error);
                        showNotification("Failed to submit review. Please try again.");
                    }
                });
            }
        }

        closeBookingModalBtn.addEventListener('click', () => bookingModal.style.display = 'none');
        window.addEventListener('click', (event) => {
            if (event.target == bookingModal) bookingModal.style.display = 'none';
        });

        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!isStudentUser) {
                showNotification("You must be logged in as a student to send a booking request.");
                return;
            }
            const subject = document.getElementById('booking-subject').value.trim();
            const message = document.getElementById('booking-message').value.trim();
            if (!subject || !message) {
                showNotification("Please fill in all fields.");
                return;
            }
            const bookingRequestData = {
                tutorUid: currentTutorUid, 
                studentUid: loggedInUser.uid, 
                studentName: loggedInStudentName || "Anonymous",
                subject: subject, 
                message: message, 
                status: 'pending', 
                createdAt: serverTimestamp()
            };
            try {
                const tutorRequestsRef = collection(db, "tutors", currentTutorUid, "requests");
                await addDoc(tutorRequestsRef, bookingRequestData);
                showNotification("Booking request sent successfully!");
                bookingModal.style.display = 'none';
                bookingForm.reset();
            } catch (error) {
                console.error("Booking request error:", error);
                showNotification(`Failed to send request: ${error.message}`);
            }
        });

        onAuthStateChanged(auth, async (user) => {
            loggedInUser = user;
            isStudentUser = false;
            loggedInStudentName = null;
            
            if (user) {
                const studentDocRef = doc(db, "students", user.uid);
                const studentDocSnap = await getDoc(studentDocRef);
                
                if (studentDocSnap.exists()) {
                    isStudentUser = true;
                    loggedInStudentName = studentDocSnap.data().name || "Anonymous";
                }
            }
            // Always render the profile, the booking button logic will handle visibility/functionality
            await renderTutorProfile();
        });

    </script>
    <style>
        .space-y-10 > :not([hidden]) ~ :not([hidden]) { margin-top: 2.5rem; }
        .space-y-6 > :not([hidden]) ~ :not([hidden]) { margin-top: 1.5rem; }
        .space-y-4 > :not([hidden]) ~ :not([hidden]) { margin-top: 1rem; }
    </style>
</body>
</html>
