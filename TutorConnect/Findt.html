<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TutorConnect - Find Your Tutor</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/slim-select/1.27.1/slimselect.min.css" rel="stylesheet">

    <style>
        /* Base styles for Poppins and Inter fonts */
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(to bottom right, #f5f7fa, #eef1f5, #e0e6ed);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .main-header {
            background-color: #fff;
            padding: 1rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #10B981;
            text-decoration: none;
            transition: transform 0.2s ease;
        }
        .logo:hover {
            transform: scale(1.05);
        }

        .logo-icon-bg {
            background-color: #D1FAE5;
            padding: 0.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #047857;   
        }

        .main-nav a {
            color: #4B5563;
            text-decoration: none;
            margin-left: 1.5rem;
            font-weight: 500;
            transition: color 0.3s ease, transform 0.2s ease;
        }

        .main-nav a:hover {
            color: #10B981;
            transform: translateY(-2px);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        .btn-primary {
            background-color: #10B981;
            color: #fff;
            border: 2px solid #10B981;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.4);
        }
        .btn-primary:hover {
            background-color: #047857;
            border-color: #047857;
            box-shadow: 0 8px 20px rgba(4, 120, 87, 0.5);
            transform: translateY(-2px) scale(1.01);
        }
        .btn-outline {
            background-color: transparent;
            border: 2px solid #10B981;
            color: #10B981;
        }
        .btn-outline:hover {
            background-color: #D1FAE5;
            color: #047857;
            transform: translateY(-2px);
        }

        /* New Search Filter Section Styles */
        .search-filter-section {
            background: linear-gradient(135deg, #ffffff, #f0f4f8);
            border-radius: 1.5rem;
            padding: 2.5rem;
            margin-top: 2.5rem;
            box-shadow: 0 20px 50px -10px rgba(0, 0, 0, 0.15);
            border: 1px solid #e5e7eb;
        }

        .search-heading {
            font-size: 2.25rem;
            font-weight: 700;
            color: #1F2937;
            text-align: center;
            margin-bottom: 2rem;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
        }

        @media (min-width: 768px) {
            .filter-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .filter-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .filter-group {
            position: relative;
        }

        .filter-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: #4B5563;
            margin-bottom: 0.5rem;
        }

        .filter-input, .ss-main {
            width: 100%;
            border: 1px solid #D1D5DB;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            font-size: 1rem;
            color: #1F2937;
            background-color: #fff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .filter-input:focus, .ss-main.ss-open-above, .ss-main.ss-open-below {
            outline: none;
            border-color: #10B981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }
        
        .main-content-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2.5rem;
            margin-top: 2.5rem;
            flex-grow: 1;
        }
        @media (min-width: 1024px) {
            .main-content-grid {
                grid-template-columns: 3fr 2fr;
            }
        }

        .map-section {
            background-color: #e0e0e0;
            border-radius: 1.5rem;
            overflow: hidden;
            position: relative;
            min-height: 500px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #E5E7EB;
        }
        .map-section img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
        }

        .tutor-listings {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            max-height: calc(100vh - 350px);
            overflow-y: auto;
            padding-right: 0.75rem;
        }
        .tutor-listings::-webkit-scrollbar { width: 10px; }
        .tutor-listings::-webkit-scrollbar-track { background: #E5E7EB; border-radius: 10px; }
        .tutor-listings::-webkit-scrollbar-thumb { background: #9CA3AF; border-radius: 10px; }
        .tutor-listings::-webkit-scrollbar-thumb:hover { background: #6B7280; }

        .tutor-listing-card {
            background-color: #fff;
            border-radius: 1.25rem;
            padding: 1.5rem 2rem;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
            position: relative;
            border: 1px solid #F3F4F6;
        }
        .tutor-listing-card:hover {
            transform: translateY(-5px) scale(1.005);
            box-shadow: 0 12px 30px rgba(0,0,0,0.18);
        }

        .tutor-listing-avatar { width: 80px; height: 80px; border-radius: 9999px; object-fit: cover; border: 4px solid #10B981; margin-right: 1.5rem; flex-shrink: 0; }
        .tutor-info { flex-grow: 1; }
        .tutor-name { font-size: 1.5rem; font-weight: 700; color: #1F2937; margin-bottom: 0.25rem; }
        .tutor-hourly-rate { font-size: 1.25rem; font-weight: 700; color: #047857; position: absolute; top: 1.5rem; right: 2rem; background-color: #D1FAE5; padding: 0.3rem 0.8rem; border-radius: 0.75rem; }
        .tutor-rating { color: #F59E0B; display: flex; align-items: center; gap: 0.25rem; margin-bottom: 0.5rem; }
        .tutor-description { font-size: 0.95rem; color: #4B5563; margin-bottom: 1rem; line-height: 1.6; }
        .tutor-tags-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
        .tutor-tag { background-color: #E0F2F7; color: #06B6D4; padding: 0.2rem 0.7rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; white-space: nowrap; }
        .tutor-stats { display: flex; flex-wrap: wrap; gap: 1.5rem; font-size: 0.9rem; color: #6B7280; margin-bottom: 1.5rem; }
        .tutor-stats span { display: flex; align-items: center; gap: 0.4rem; }
        .tutor-stats svg { width: 1rem; height: 1rem; color: #6B7280; }
        .tutor-actions { display: flex; gap: 1rem; justify-content: flex-end; margin-top: auto; padding-top: 1rem; border-top: 1px solid #E5E7EB; }
        .tutor-actions .btn { font-size: 0.9rem; padding: 0.6rem 1.2rem; }
        
        /* Custom styling for Slim Select */
        .ss-main { border: none; border-radius: 0.75rem; padding: 0; width: 100%; background-color: #fff; }
        .ss-single-selected, .ss-multi-selected { padding: 0.75rem 1rem; border: 1px solid #D1D5DB; border-radius: 0.75rem; }
        .ss-content { border-radius: 0.5rem; }

        @media (max-width: 768px) {
            .main-nav, .header-actions { display: none; }
            .nav-container { justify-content: center; flex-wrap: wrap; }
            .logo { width: 100%; text-align: center; justify-content: center; margin-bottom: 1rem; }
            .tutor-listings { max-height: unset; overflow-y: visible; padding-right: 0; }
        }
    </style>
    
    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body class="flex flex-col">

    <header class="main-header animate__animated animate__fadeInDown animate__faster">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <div class="logo-icon-bg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>
                </div>
                <span>TutorConnect</span>
            </a>
            <nav class="main-nav">
                <a href="#">Find Tutors</a>
            </nav>
            <div class="header-actions">
                <a href="StudentProfile.html" class="btn btn-outline">My Profile</a>
            </div>
        </div>
    </header>

    <main class="container py-8 flex-grow">
        <section id="search-filter-section-anchor" class="search-filter-section">
            <h2 class="search-heading">Find Your Perfect Tutor</h2>
            <div class="filter-grid">
                <div class="filter-group lg:col-span-2">
                    <label for="search-tutors" class="filter-label">Search by Name or Subject</label>
                    <input type="text" id="search-tutors" name="search-tutors" placeholder="e.g., Jane Doe or Physics" class="filter-input">
                </div>
                 <div class="filter-group">
                    <label for="filter-subject" class="filter-label">Filter by Subject</label>
                    <select id="filter-subject" name="filter-subject"></select>
                </div>
                 <div class="filter-group">
                    <label for="max-rate" class="filter-label">Max Hourly Rate</label>
                    <select id="max-rate" name="max-rate" class="filter-input">
                        <option value="any">Any Rate</option>
                        <option value="5000">Up to Rs. 5000</option>
                        <option value="3000">Up to Rs. 3000</option>
                        <option value="2000">Up to Rs. 2000</option>
                        <option value="1500">Up to Rs. 1500</option>
                        <option value="1000">Up to Rs. 1000</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="user-hometown" class="filter-label">Your Hometown</label>
                    <select id="user-hometown"></select>
                </div>
                <div class="filter-group lg:col-span-2">
                    <label for="user-nearby-towns" class="filter-label">Nearby Towns of Interest</label>
                    <select id="user-nearby-towns" multiple></select>
                </div>
            </div>
        </section>

        <section class="main-content-grid">
            <div class="map-section">
                <img src="https://placehold.co/800x600/e0ffe0/047857?text=Map+View" alt="Map of tutor locations">
            </div>

            <div class="tutor-listings">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold text-gray-800" id="tutor-count">Loading tutors...</h2>
                </div>
                <div id="tutors-container" class="space-y-4">
                </div>
            </div>
        </section>
    </main>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slim-select/1.27.1/slimselect.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXIlpd17s5xEIyct8PRJVaNNA6QajqGjE",
            authDomain: "tutorconnect-a9b1e.firebaseapp.com",
            projectId: "tutorconnect-a9b1e",
            storageBucket: "tutorconnect-a9b1e.appspot.com",
            messagingSenderId: "511276105084",
            appId: "1:511276105084:web:25dc9ef6fc8c7ce2efb8f9",
            measurementId: "G-7M72STVQKP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const searchInput = document.getElementById('search-tutors');
        const maxRate = document.getElementById('max-rate');
        const tutorsContainer = document.getElementById('tutors-container');
        const tutorCountElement = document.getElementById('tutor-count');

        let allTutors = [];
        let hometownFilter, nearbyTownsFilter, subjectFilter;

        const sriLankaTowns = ["Achchuvely", "Adampan", "Addalaichenai", "Adhikarigama", "Adippala", "Agalawatta", "Agaliya", "Agarapathana", "Agbopura", "Ahangama", "Ahungalla", "Akaragama", "Akarawita", "Akarella", "Akkaraipattu", "Akmeemana", "Akuramboda", "Akurana", "Akuressa", "Alahengama", "Alahitiyawa", "Alapaladeniya", "Alawala", "Alawatugoda", "Alawatura", "Alawatuwala", "Alawwa", "Algama", "Allaipiddi", "Alubomulla", "Alutgama", "Alutnuwara", "Aluthwala", "Alvai", "Alwatta", "Ambalangoda", "Ambalantota", "Ambana", "Ambanpola", "Ampara", "Ampitiya", "Amunakole", "Anaicoddai", "Analaitivu", "Anamaduwa", "Andiambalama", "Andigama", "Angoda", "Angunakolapelessa", "Anguruwatota", "Anhandiya", "Ankokkawala", "Ankumbura", "Anuradhapura", "Apparekka", "Aralaganwila", "Aranayaka", "Arawakumbura", "Aruggammana", "Aselapura", "Atabage", "Atakalanpanna", "Atale", "Ataragalla", "Athurugiriya", "Attanagalla", "Avissawella", "Ayithiyamalai", "Badalkumbura", "Baddegama", "Badulla", "Baduraliya", "Bakamuna", "Bakiella", "Balagolla", "Balalla", "Balangoda", "Balapitiya", "Bambalapitiya", "Bambarapana", "Bandaragama", "Bandarawela", "Bangadeniya", "Barawakumbuka", "Batapola", "Batawala", "Battaramulla", "Batticaloa", "Batuwatta", "Beliatta", "Belihuloya", "Bellana", "Bemmulla", "Bentota", "Beruwala", "Bibile", "Bingiriya", "Biyagama", "Bokalagama", "Bollete (WP)", "Bope", "Boralesgamuwa", "Borella", "Bothale Ihalagama", "Bowalagama", "Bulathkohupitiya", "Bulathsinhala", "Buttala", "Chankanai", "Chavakachcheri", "Cheddikulam", "Chenkaladi", "Chilaw", "Chunnakam", "Colombo", "Colpetty", "Dambadeniya", "Dambagalla", "Dambana", "Dambulla", "Dankotuwa", "Danowita", "Dedigamuwa", "Deegala Lenama", "Dehiattakandiya", "Dehiowita", "Dehiwala-Mount Lavinia", "Dekatana", "Delgoda", "Dellawa", "Delmella", "Deltara", "Deltota", "Demanhandiya", "Denagama", "Deniyaya", "Deraniyagala", "Devinuwara", "Dharga Town", "Digana", "Dikoya", "Dikwella", "Divulapitiya", "Dodangaslanda", "Doluwa", "Dompe", "Doranagoda", "Dumbara", "Dunagaha", "Eheliyagoda", "Elpitiya", "Embilipitiya", "Eppawala", "Eravur", "Etawatunuwewa", "Ethkandura", "Fort", "Galagedara", "Galaha", "Galapitamada", "Galatara", "Galenbindunuwewa", "Galewela", "Galgamuwa", "Galle", "Galpatha", "Gampaha", "Gampola", "Ganemulla", "Ganga Ihala Korale", "Ganewatta", "Ginigathhena", "Giriulla", "Godagama", "Godakawela", "Gokarella", "Gonagaldeniya", "Gonapinuwala", "Gonawala", "Gothatuwa", "Habarakada", "Habarana", "Hakmana", "Hali-Ela", "Hambantota", "Handapangoda", "Handessa", "Hanguranketha", "Hanwella", "Hapugastalawa", "Haputale", "Harispattuwa", "Hatton", "Havelock Town", "Hendala", "Henegama", "Hettimulla", "Hettipola", "Hewainna", "Hikkaduwa", "Hingula", "Hingurakgoda", "Hingurana", "Hiripitya", "Hiswella", "Hokandara", "Homagama", "Horana", "Horampella", "Hulangamuwa", "Hunumulla", "Ibbagamuwa", "Ihala Madampella", "Imaduwa", "Imbulgoda", "Ingiriya", "Inuvil", "Ipalogama", "Ittapana", "Ja-Ela", "Jaffna", "Kadawatha", "Kadugannawa", "Kaduwela", "Kahaduwa", "Kahataruppa", "Kahawatta", "Kalagedihena", "Kalawana", "Kalkudah", "Kalmunai", "Kalutara", "Kamburupitiya", "Kandana", "Kandy", "Kantale", "Kapugoda", "Karadiyanaru", "Karagahatenna", "Karampon", "Karaveddy", "Kataragama", "Kathiraveli", "Kattankudy", "Katunayake", "Katuneriya", "Katuwana", "Kebithigollewa", "Kegalle", "Kekirawa", "Kelaniya", "Kendagolla", "Kesbewa", "Kilinochchi", "Kinniya", "Kirama", "Kiran", "Kiribathgoda", "Kirinda", "Kiriwattuduwa", "Kirulapone", "Kitulgala", "Kochchikade", "Kodikamam", "Koggala", "Kohuwala", "Kokkadicholai", "Kolonnawa", "Kopay", "Kosgama", "Kosgoda", "Koslanda", "Kotahena", "Kotikawatta", "Kottawa", "Kotte", "Kottegoda", "Kuliyapitiya", "Kundasale", "Kurunegala", "Kuruvita", "Lihiriyagama", "Loluwagoda", "Lunugamvehera", "Lunugala", "Lunugama", "Lunuvila", "Mabole", "Madahapola", "Madampe", "Madapatha", "Madawachchiya", "Madelgamuwa", "Madulla", "Madulsima", "Mahagama", "Mahakumbukkadawala", "Mahanuwara", "Maharagama", "Mahawela", "Mahiyanganaya", "Makandura", "Makewita", "Makola", "Malabe", "Mallakam", "Mandapam", "Mandawala", "Mannar", "Mapalagama", "Maradana", "Marassana", "Marawila", "Maskeliya", "Matale", "Matara", "Mattegoda", "Matugama", "Mawanella", "Mawathagama", "Medawachchiya", "Meddegama", "Medirigiriya", "Meegahatenna", "Meegoda", "Meethirigala", "Melsiripura", "Middeniya", "Mihintale", "Millaniya", "Minuwangoda", "Mirigama", "Mirissa", "Monaragala", "Moragahahena", "Moratuwa", "Morawaka", "Mount Lavinia", "Mullaitivu", "Mulleriyawa New Town", "Mutur", "Mutwal", "Nagoda", "Nakkawatta", "Nalanda", "Nanu Oya", "Napawela", "Narahenpita", "Narammala", "Nattandiya", "Naula", "Nawalapitiya", "Nawana", "Negombo", "Nelliady", "Nikaweratiya", "Nittambuwa", "Nugegoda", "Nuwara Eliya", "Oddamavadi", "Ohiya", "Padukka", "Paiyagala", "Palavi", "Pallekele", "Pallewela", "Pamanugama", "Panadura", "Pannala", "Pannipitiya", "Parakaduwa", "Passara", "Pasyala", "Pelawatta", "Peliyagoda", "Pelmadulla", "Peradeniya", "Pettah", "Pilimathalawa", "Piliyandala", "Pitigala", "Point Pedro", "Polgahawela", "Polgasowita", "Polonnaruwa", "Polpithimukulana", "Poruwadanda", "Pottuvil", "Pugoda", "Pujapitiya", "Punakarin", "Pundaluoya", "Pussellawa", "Puttalam", "Puwakpitiya", "Radawana", "Radawadunna", "Raddolugama", "Ragama", "Rajagiriya", "Rakwana", "Rambukkana", "Ranala", "Ranna", "Rathgama", "Ratmalana", "Ratnapura", "Ridee", "Ruwanwella", "Sainthamaruthu", "Saliyapura", "Sandilipay", "Seeduwa", "Serunuwara", "Siddamulla", "Sigiriya", "Slave Island", "Soranathota", "Sri Jayawardenepura Kotte", "Talawatugoda", "Talawakelle", "Tanamalwila", "Tangalle", "Teldeniya", "Tellippalai", "Thambuththegama", "Thanamalvila", "Thavady", "Theldeniya", "Thihagoda", "Thimbirigaskatuwa", "Tirunelveli", "Tissamaharama", "Trincomalee", "Tummodara", "Udagama", "Udappu", "Udathuthiripitiya", "Udugampola", "Udugoda", "Udumulla", "Uduvil", "Uggalboda", "Undugoda", "Unnichchai", "Urumpirai", "Uswetakeiyawa", "Vakaneri", "Valaichenai", "Valvettithurai", "Vavuniya", "Veyangoda", "Wadduwa", "Waga", "Waikkal", "Warakapola", "Wariyapola", "Watareka", "Wattala", "Wattegama", "Weligama", "Welikanda", "Welimada", "Wellawatta", "Wellawaya", "Wennappuwa", "Yakkala", "Yala", "Yatiyantota"].sort();

        const createTutorCard = (tutor) => {
            const avatarText = tutor.name ? tutor.name.split(' ').map(n => n[0]).join('').toUpperCase() : 'NA';
            const subjectsHtml = (tutor.subject || '').split(',').map(s => s.trim()).filter(s => s).map(s => `<span class="tutor-tag">${s}</span>`).join('');
            const rating = (Math.random() * (5 - 3.5) + 3.5).toFixed(1);
            const stars = '★'.repeat(Math.floor(rating)) + '☆'.repeat(5 - Math.floor(rating));
            return `<div class="tutor-listing-card"><div class="flex items-start"><img src="https://placehold.co/80x80/D1FAE5/047857?text=${avatarText}" alt="Tutor ${tutor.name}" class="tutor-listing-avatar"><div class="tutor-info"><h3 class="tutor-name">${tutor.name}</h3><div class="tutor-rating">${stars} <span class="text-gray-500 text-xs ml-1">(${rating})</span></div><p class="tutor-hourly-rate">Rs. ${tutor.rate}/hr</p><p class="tutor-description">${tutor.education || 'Experienced and dedicated tutor.'}</p><div class="tutor-tags-list">${subjectsHtml}</div><div class="tutor-stats"><span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>${tutor.experience || 0} years exp.</span><span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>${tutor.hometown || 'Not set'}</span></div></div></div><div class="tutor-actions"><a href="TutorP.html?uid=${tutor.id}" class="btn btn-outline">View Profile</a><a href="TutorP.html?uid=${tutor.id}#request-booking-btn" class="btn btn-primary">Request to Book</a></div></div>`;
        };
        
        const renderTutors = (tutorsToRender) => {
            tutorsContainer.innerHTML = '';
            if (tutorsToRender.length === 0) {
                tutorsContainer.innerHTML = '<p class="text-center text-gray-500 text-lg py-10">No tutors found matching your criteria.</p>';
            } else {
                tutorsToRender.forEach((tutor) => {
                    tutorsContainer.innerHTML += createTutorCard(tutor);
                });
            }
            tutorCountElement.textContent = `${tutorsToRender.length} Tutors Available`;
        };

        const applyFiltersAndSort = () => {
            let filteredTutors = [...allTutors];
            const searchTerm = searchInput.value.toLowerCase().trim();
            if (searchTerm) {
                filteredTutors = filteredTutors.filter(tutor =>
                    tutor.name.toLowerCase().includes(searchTerm) || (tutor.subject && tutor.subject.toLowerCase().includes(searchTerm))
                );
            }
            const selectedSubject = subjectFilter.selected();
            if (selectedSubject && selectedSubject !== 'all') {
                filteredTutors = filteredTutors.filter(tutor =>
                    tutor.subject && tutor.subject.toLowerCase().includes(selectedSubject.toLowerCase())
                );
            }
            const selectedMaxRate = parseFloat(maxRate.value);
            if (!isNaN(selectedMaxRate) && maxRate.value !== 'any') {
                filteredTutors = filteredTutors.filter(tutor =>
                    tutor.rate && parseFloat(tutor.rate) <= selectedMaxRate
                );
            }
            const userHometown = hometownFilter.selected();
            const userNearbyTowns = nearbyTownsFilter.selected();
            if (userHometown) {
                 filteredTutors.sort((a, b) => {
                    const getScore = (tutor) => {
                        const tutorNearby = Array.isArray(tutor.nearbyTowns) ? tutor.nearbyTowns : [];
                        const userNearby = Array.isArray(userNearbyTowns) ? userNearbyTowns : [];
                        if (tutor.hometown === userHometown || tutorNearby.includes(userHometown)) return 1;
                        if (userNearby.length > 0) {
                            if (userNearby.includes(tutor.hometown)) return 2;
                            if (tutorNearby.some(tutorTown => userNearby.includes(tutorTown))) return 2;
                        }
                        if (tutor.method === 'online' || tutor.method === 'both') return 3;
                        return 4;
                    };
                    return getScore(a) - getScore(b);
                });
            }
            renderTutors(filteredTutors);
        };

        const initializeFilters = (tutors) => {
            const allSubjects = new Set();
            tutors.forEach(tutor => {
                if(tutor.subject) tutor.subject.split(',').forEach(s => allSubjects.add(s.trim()));
            });
            const subjectOptions = [{ text: 'All Subjects', value: 'all' }, ...Array.from(allSubjects).sort().map(s => ({ text: s, value: s }))];
            subjectFilter = new SlimSelect({
                select: '#filter-subject', data: subjectOptions, onChange: applyFiltersAndSort
            });
            hometownFilter = new SlimSelect({
                select: '#user-hometown', data: [{text: 'Select Hometown', placeholder: true}, ...sriLankaTowns.map(t => ({text: t, value: t}))], onChange: applyFiltersAndSort
            });
            nearbyTownsFilter = new SlimSelect({
                select: '#user-nearby-towns', data: sriLankaTowns.map(t => ({text: t, value: t})), placeholder: 'Select nearby towns', onChange: applyFiltersAndSort
            });
        };
        
        async function handleUserSession(user) {
            if (user) {
                const studentDocRef = doc(db, "students", user.uid);
                try {
                    const studentDocSnap = await getDoc(studentDocRef);
                    if (studentDocSnap.exists()) {
                        const studentData = studentDocSnap.data();
                        if (studentData.hometown && hometownFilter) {
                            hometownFilter.set(studentData.hometown);
                        }
                    }
                } catch (error) { console.error("Error fetching student profile:", error); }
            }
        }

        async function fetchTutorsAndSetup() {
            try {
                const tutorsCol = collection(db, "tutors");
                const q = query(tutorsCol, orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                allTutors = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                initializeFilters(allTutors);
                applyFiltersAndSort();
                
                onAuthStateChanged(auth, (user) => {
                    handleUserSession(user);
                });

            } catch (error) {
                console.error("Error fetching tutors: ", error);
                tutorsContainer.innerHTML = '<p class="text-center text-red-500">Error loading tutors.</p>';
            }
        }

        searchInput.addEventListener('input', applyFiltersAndSort);
        maxRate.addEventListener('change', applyFiltersAndSort);
        document.addEventListener('DOMContentLoaded', fetchTutorsAndSetup);
    </script>
</body>
</html>
