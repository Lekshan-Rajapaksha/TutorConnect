<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TutorConnect - Find Your Perfect Tutor</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.css" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            --primary-color: #4f46e5;
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --surface-color: #ffffff;
            --text-color: #374151;
            --heading-color: #111827;
            --border-color: #e5e7eb;
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 6px 12px rgba(0, 0, 0, 0.08);
            --shadow-lg: 0 12px 20px rgba(0, 0, 0, 0.1);
            --border-radius: 1rem;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #5a99d7, #2d3e60, #75afd8);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            color: var(--heading-color);
        }

        .container {
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }

        .content-layout {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            align-items: flex-start;
            margin-top: 1.5rem;
        }

        @media (min-width: 1024px) {
            .content-layout {
                grid-template-columns: 3fr 2fr;
            }
        }

        .map-container {
            position: sticky;
            top: 100px;
            height: calc(100vh - 120px);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .tutors-container {
            height: calc(100vh - 120px);
            overflow-y: auto;
            padding-right: 1rem;
            padding-left: 2rem;
        }

        .main-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 1.25rem 0;
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .nav-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--heading-color);
            text-decoration: none;
        }

        .btn {
            padding: 0.75rem 1rem;
            border-radius: 9999px;
            text-decoration: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            border: 2px solid transparent;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-md);
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(79, 70, 229, 0.3);
        }

        .btn-outline {
            background: transparent;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        .btn-outline:hover {
            background: var(--primary-color);
            color: rgb(231, 221, 221);
            transform: translateY(-2px);
        }

        /* === UPDATED SEARCH & FILTER SECTION === */
        .search-filter-section {
            background: linear-gradient(145deg, var(--surface-color), #f8fafc);
            border-radius: 1.5rem;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(79, 70, 229, 0.1);
            position: relative;
            overflow: hidden;
        }

        .search-heading {
            font-size: 2.5rem;
            font-weight: 800;
            text-align: center;
            margin-bottom: 2rem;
            background: linear-gradient(135deg, #4f46e5, #10b981, #f59e0b);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(1, 1fr);
            gap: 1.5rem;
            align-items: end;
        }

        @media (min-width: 640px) { .filter-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (min-width: 1024px) { .filter-grid { grid-template-columns: 2fr 1fr 1fr 1fr 1fr; } }
        @media (min-width: 1280px) { .filter-grid { grid-template-columns: 3fr 1.5fr 1.5fr 1.5fr 1.5fr 1fr; } }


        .filter-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.75rem;
        }

        .filter-input, .ss-main .ss-single-selected {
            width: 100%;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 0.85rem 1.25rem;
            font-size: 1rem;
            color: var(--heading-color);
            background-color: var(--surface-color);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .filter-input:focus, .ss-main.ss-open-above .ss-single-selected, .ss-main.ss-open-below .ss-single-selected {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2);
        }

        /* Making the search input larger */
        #search-tutors-group {
            grid-column: span 1 / span 1;
        }
        @media (min-width: 1024px) { #search-tutors-group { grid-column: span 2 / span 2; } }
        @media (min-width: 1280px) { #search-tutors-group { grid-column: span 1 / span 1; } }

        /* Aligning the search button */
        .search-btn-container {
            grid-column: span 1 / span 1;
        }
        @media (min-width: 1280px) {
            .search-btn-container {
                display: flex;
                align-items: flex-end;
            }
        }
        #search-button {
            width: 100%;
            height: calc(2.25rem + 2px); /* Match input height */
            padding: 0.85rem 1.25rem;
        }

        .tutors-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        /* === NEW UNIQUE & BEAUTIFUL CARD STYLES === */
        .tutor-listing-card {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 1.5rem;
            padding: 1.5rem;
            display: flex;
            flex-direction: row;
            position: relative;
            transform-style: preserve-3d;
            will-change: transform;
            transition: transform 0.1s ease-out, box-shadow 0.3s ease;
            overflow: hidden;
        }

        .tutor-listing-card:hover {
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        /* Gradient glow border effect */
        .tutor-listing-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border-radius: 1.5rem;
            background: linear-gradient(135deg, #5a99d7, #b9bd7a, #75afd8);
            z-index: -2;
            filter: blur(18px);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .tutor-listing-card:hover::before {
            opacity: 0.6;
        }

        /* Shine effect on hover */
        .shine-effect {
            position: absolute;
            top: 0;
            left: -150%;
            width: 100%;
            height: 100%;
            background: linear-gradient(105deg, transparent 30%, rgba(255, 255, 255, 0.7) 50%, transparent 70%);
            transform: skewX(-25deg);
            transition: left 0.6s ease;
            pointer-events: none;
            z-index: 1;
        }

        .tutor-listing-card:hover .shine-effect {
            left: 150%;
        }

        .tutor-card-avatar-section {
            display: flex;
            align-items: flex-start;
            margin-right: 1.5rem;
            flex-shrink: 0;
            z-index: 2;
        }

        .tutor-listing-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid rgba(255, 255, 255, 0.9);
            background: var(--surface-color);
            padding: 4px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .tutor-card-content {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            min-width: 0;
            z-index: 2;
        }

        .tutor-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .tutor-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #101217;
        }

        .tutor-rating {
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: var(--accent-color);
        }

        .tutor-description {
            font-size: 0.75rem;
            color: #1d1f23;
            margin: 0.75rem 0;
            flex-grow: 1;
            line-height: 1.5;
        }

        .tutor-tags-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tutor-tag {
            background: rgba(255, 255, 255, 0.5);
            color: #1e2127;
            padding: 0.3rem 0.8rem;
            border-radius: 9999px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.7);
        }

        .tutor-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 1rem;
            border-top: 1px solid rgba(46, 39, 39, 0.6);
            gap: 1rem;
        }

        .tutor-stats {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller cards */
            gap: 1rem;
            font-size: 0.85rem;
            color: #26292e;
            align-items: center;
        }

        .tutor-stats svg {
            width: 1rem;
            height: 1rem;
            color: var(--primary-color);
            flex-shrink: 0;
        }

        .tutor-hourly-rate {
            font-size: 1.4rem;
            font-weight: 800;
            color:  #26292e;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        /* === END OF NEW CARD STYLES === */

        .ss-main { border: none; }
        .ss-main .ss-single-selected { padding: 0; border: none; box-shadow: none; }
        .ss-content { border-radius: 0.75rem; box-shadow: var(--shadow-md); border: 1px solid var(--border-color); }
        .ss-content .ss-list .ss-option.ss-highlighted, .ss-content .ss-list .ss-option:hover { background-color: var(--primary-color); color: white; }

        .section-heading {
            font-size: 1.75rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid rgba(255,255,255,0.7);
            display: inline-block;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }

        @media (max-width: 1023px) {
            .map-container { position: relative; top: auto; height: 450px; }
            .tutors-container { height: auto; overflow-y: visible; }
        }

        @media (max-width: 768px) {
            .main-nav, .header-actions { display: none; }
            .nav-container { justify-content: center; }
            .search-heading { font-size: 2.25rem; }
        }
    </style>

    <link rel="icon" href="favicon.ico" type="image/x-icon">
</head>
<body class="bg-gray-50">

    <header class="main-header">
        <div class="container nav-container">
            <a href="index.html" class="logo">
                <div class="logo-icon-bg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"></path><path d="M6 12v5c3 3 9 3 12 0v-5"></path></svg>
                </div>
                <span>TutorConnect</span>
            </a>
            <div class="header-actions hidden md:block">
                <a href="StudentProfile.html" class="btn btn-outline">My Profile</a>
            </div>
        </div>
    </header>

    <main class="container py-6 flex-grow">
        <section id="search-filter-section-anchor" class="search-filter-section mb-6">
            <h2 class="search-heading">Discover Your Ideal Tutor</h2>
            <div class="filter-grid">
                <div id="search-tutors-group" class="filter-group">
                    <label for="search-tutors" class="filter-label">Search by Name or Subject</label>
                    <input type="text" id="search-tutors" name="search-tutors" placeholder="e.g., Jane Doe or Physics" class="filter-input">
                </div>
                <div class="filter-group">
                    <label for="filter-subject" class="filter-label">Subject</label>
                    <select id="filter-subject" name="filter-subject"></select>
                </div>
                <div class="filter-group">
                    <label for="filter-method" class="filter-label">Method</label>
                    <select id="filter-method" name="filter-method">
                        <option value="any">Any</option>
                        <option value="online">Online</option>
                        <option value="in-person">In-Person</option>
                        <option value="both">Both</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="max-rate" class="filter-label">Max Rate (LKR)</label>
                    <select id="max-rate" name="max-rate">
                        <option value="any">Any</option>
                        <option value="5000">Up to 5000</option>
                        <option value="3000">Up to 3000</option>
                        <option value="2000">Up to 2000</option>
                        <option value="1500">Up to 1500</option>
                        <option value="1000">Up to 1000</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="user-hometown" class="filter-label">Your Location</label>
                    <select id="user-hometown"></select>
                </div>
                <div class="search-btn-container">
                     <button id="search-button" class="btn btn-primary">
                          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                          <span class="hidden lg:inline">Search</span>
                     </button>
                </div>
            </div>
        </section>
        <div class="content-layout">
            <div class="map-container">
                <div id="map"></div>
            </div>
            <div class="tutors-container">
                <section id="tutor-listings-section" class="tutor-listings">
                    <div id="loading-indicator" class="text-center py-10">
                        <svg class="animate-spin h-10 w-10 text-white mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-4 text-lg font-semibold text-white">Finding the best tutors for you...</p>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/slim-select/2.8.2/slimselect.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBXIlpd17s5xEIyct8PRJVaNNA6QajqGjE",
            authDomain: "tutorconnect-a9b1e.firebaseapp.com",
            projectId: "tutorconnect-a9b1e",
            storageBucket: "tutorconnect-a9b1e.appspot.com",
            messagingSenderId: "511276105084",
            appId: "1:511276105084:web:25dc9ef6fc8c7ce2efb8f9",
            measurementId: "G-7M72STVQKP"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        const searchInput = document.getElementById('search-tutors');
        const maxRateEl = document.getElementById('max-rate');
        const methodFilterEl = document.getElementById('filter-method');
        const tutorListingsSection = document.getElementById('tutor-listings-section');
        const searchButton = document.getElementById('search-button');

        let allTutors = [];
        let hometownFilter, subjectFilter;
        let map;
        let mapMarkers = [];
        let locationCircle = null;
        let townCoordsCache = {};
        
        // --- ADDED: Comprehensive Subject List ---
        const sriLankaSubjects = [
            "Grade 1 Sinhala", "Grade 1 Mathematics", "Grade 1 Environmental", "Grade 1 Religion", "Grade 1 English",
            "Grade 2 Sinhala", "Grade 2 Mathematics", "Grade 2 Environmental", "Grade 2 Religion", "Grade 2 English", 
            "Grade 3 Sinhala", "Grade 3 Mathematics", "Grade 3 Environmental", "Grade 3 Religion", "Grade 3 English", "Grade 3 English", "Grade 3 Scolership", "Grade 3 Tamil",
            "Grade 4 Sinhala", "Grade 4 Mathematics", "Grade 4 Environmental", "Grade 4 Religion", "Grade 4 English", "Grade 4 English", "Grade 4 Scolership", "Grade 4 Tamil",
            "Grade 5 Sinhala", "Grade 5 Mathematics", "Grade 5 Environmental", "Grade 5 Religion", "Grade 5 English", "Grade 5 English", "Grade 5 Scolership", "Grade 5 Tamil",
            "Grade 6 Sinhala", "Grade 6 Mathematics", "Grade 6 English", "Grade 6 Science", "Grade 6 History", "Grade 6 Religion", "Grade 6 Geography", "Grade 6 Civics Education", "Grade 6 Health ", "Grade 6 Tamil", "Grade 6 Dancing", 
            "Grade 7 Sinhala", "Grade 7 Mathematics", "Grade 7 English", "Grade 7 Science", "Grade 7 History", "Grade 7 Religion", "Grade 7 Geography", "Grade 7 Civics Education", "Grade 7 Health ", "Grade 7 Tamil", "Grade 7 Dancing",  "Grade 7 ICT",
            "Grade 8 Sinhala", "Grade 8 Mathematics", "Grade 8 English", "Grade 8 Science", "Grade 8 History", "Grade 8 Religion", "Grade 8 Geography", "Grade 8 Civics Education", "Grade 8 Health ", "Grade 8 Tamil", "Grade 8 Dancing",  "Grade 8 ICT",
            "Grade 9 Sinhala", "Grade 9 Mathematics", "Grade 9 English", "Grade 9 Science", "Grade 9 History", "Grade 9 Religion", "Grade 9 Geography", "Grade 9 Civics Education", "Grade 9 Health ", "Grade 9 Tamil", "Grade 9 Dancing",  "Grade 9 ICT",
            "Grade 10 Religion", "Grade 10 Sinhala", "Grade 10 English", "Grade 10 Mathematics", "Grade 10 Science", "Grade 10 History", "Grade 10 History", "Grade 10 Commerce", "Grade 10 English Literary ",
            "Grade 11 Religion", "Grade 11 Sinhala", "Grade 11 English", "Grade 11 Mathematics", "Grade 11 Science", "Grade 11 History", "Grade 11 History", "Grade 11 Commerce", "Grade 11 English Literary ",
            "A/L Combined Mathematics", "A/L Physics", "A/L Chemistry", "A/L Biology", "A/L Agricultural Science",
            "A/L Accounting", "A/L Business Studies", "A/L Economics", "A/L Business Statistics",
            "A/L Political Science", "A/L Logic and Scientific Method", "A/L History of Sri Lanka & Modern World", "A/L Geography", "A/L Buddhist Civilization", "A/L Hindu Civilization", "A/L Islamic Civilization", "A/L Christian Civilization", "A/L Greek and Roman Civilization",
            "A/L French", "A/L German", "A/L Japanese", "A/L Hindi", "A/L Arabic", "A/L Chinese", "A/L Russian", "A/L Pali", "A/L Sanskrit", "A/L Sinhala", "A/L Tamil", "A/L English",
            "A/L Drama and Theatre (Sinhala/Tamil/English)", "A/L Art", "A/L Music (Oriental/Carnatic/Western)", "A/L Dancing (Indigenous/Bharatha)",
            "A/L Communication and Media Studies", "A/L Engineering Technology", "A/L Bio-systems Technology", "A/L Science for Technology",
            "A/L General English", "A/L General Information Technology","Programming","Java","Web Development"
        ].sort();

        const sriLankaTowns = ["Achchuvely", "Adampan", "Addalaichenai", "Adhikarigama", "Adippala", "Agalawatta", "Agaliya", "Agarapathana", "Agbopura", "Ahangama", "Ahungalla", "Akaragama", "Akarawita", "Akarella", "Akkaraipattu", "Akmeemana", "Akuramboda", "Akurana", "Akuressa", "Alahengama", "Alahitiyawa", "Alapaladeniya", "Alawala", "Alawatugoda", "Alawatura", "Alawatuwala", "Alawwa", "Algama", "Allaipiddi", "Alubomulla", "Alutgama", "Alutnuwara", "Aluthwala", "Alvai", "Alwatta", "Ambalangoda", "Ambalantota", "Ambana", "Ambanpola", "Ambewela", "Ampara", "Ampitiya", "Amunakole", "Anaicoddai", "Analaitivu", "Anamaduwa", "Andiambalama", "Andigama", "Angoda", "Angunakolapelessa", "Anguruwatota", "Anhandiya", "Ankokkawala", "Ankumbura", "Anuradhapura", "Apparekka", "Aralaganwila", "Aranayaka", "Arawakumbura", "Aruggammana", "Arugam Bay", "Aselapura", "Atabage", "Atakalanpanna", "Atale", "Ataragalla", "Athurugiriya", "Attanagalla", "Avissawella", "Ayagama", "Ayithiyamalai", "Badalkumbura", "Baddegama", "Badulla", "Baduraliya", "Bakamuna", "Bakiella", "Balagolla", "Balalla", "Balangoda", "Balapitiya", "Bambalapitiya", "Bambarapana", "Bandaragama", "Bandarawela", "Bangadeniya", "Barawakumbuka", "Batapola", "Batawala", "Battaramulla", "Batticaloa", "Batuwatta", "Beliatta", "Belihuloya", "Bellana", "Bellanwila", "Bemmulla", "Bentota", "Beruwala", "Bibile", "Bingiriya", "Biyagama", "Bogawantalawa", "Bokalagama", "Bollete (WP)", "Bope", "Boralesgamuwa", "Borella", "Bothale Ihalagama", "Bowalagama", "Bulathkohupitiya", "Bulathsinhala", "Buttala", "Chankanai", "Chavakachcheri", "Cheddikulam", "Chenkaladi", "Chilaw", "Chunnakam", "Colombo", "Colpetty", "Dambadeniya", "Dambagalla", "Dambana", "Dambulla", "Dankotuwa", "Danowita", "Dedigamuwa", "Deegala Lenama", "Dehiattakandiya", "Dehiowita", "Dehiwala-Mount Lavinia", "Dekatana", "Delgoda", "Dellawa", "Delmella", "Deltara", "Deltota", "Demanhandiya", "Denagama", "Deniyaya", "Deraniyagala", "Devinuwara", "Dharga Town", "Digana", "Dikoya", "Dikwella", "Diyatalawa", "Divulapitiya", "Dodangaslanda", "Doluwa", "Dompe", "Doranagoda", "Dumbara", "Dunagaha", "Eheliyagoda", "Elephant Pass", "Ella", "Elpitiya", "Embilipitiya", "Eppawala", "Eravur", "Etawatunuwewa", "Ethkandura", "Fort", "Galagedara", "Galaha", "Galapitamada", "Galatara", "Galenbindunuwewa", "Galewela", "Galgamuwa", "Galle", "Galnewa", "Galpatha", "Gampaha", "Gampola", "Ganemulla", "Ganga Ihala Korale", "Ganewatta", "Ginigathhena", "Giriulla", "Godagama", "Godakawela", "Gokarella", "Gonagaldeniya", "Gonapinuwala", "Gonawala", "Gothatuwa", "Habarakada", "Habarana", "Hakmana", "Hali-Ela", "Hambantota", "Handapangoda", "Handessa", "Hanguranketha", "Hanwella", "Hapugastalawa", "Haputale", "Harispattuwa", "Hatton", "Havelock Town", "Hendala", "Henegama", "Hettimulla", "Hettipola", "Hewainna", "Hikkaduwa", "Hingula", "Hingurakgoda", "Hingurana", "Hiripitya", "Hiswella", "Hokandara", "Homagama", "Horana", "Horampella", "Horowpathana", "Hulangamuwa", "Hunumulla", "Ibbagamuwa", "Ihala Madampella", "Imaduwa", "Imbulgoda", "Ingiriya", "Inuvil", "Ipalogama", "Ittapana", "Ja-Ela", "Jaffna", "Kadawatha", "Kadugannawa", "Kaduwela", "Kahaduwa", "Kahataruppa", "Kahawatta", "Kalagedihena", "Kalawana", "Kalkudah", "Kalmunai", "Kalpitiya", "Kalutara", "Kamburupitiya", "Kandana", "Kandeketiya", "Kandy", "Kantale", "Kapugoda", "Karadiyanaru", "Karagahatenna", "Karampon", "Karaveddy", "Kataragama", "Kathiraveli", "Kattankudy", "Katugastota", "Katunayake", "Katuneriya", "Katuwana", "Kayts", "Kebithigollewa", "Kegalle", "Kekirawa", "Kelaniya", "Kendagolla", "Kesbewa", "Kilinochchi", "Kinniya", "Kirama", "Kiran", "Kiribathgoda", "Kirinda", "Kiriwattuduwa", "Kirulapone", "Kitulgala", "Kochchikade", "Kodikamam", "Koggala", "Kokkilai", "Kohuwala", "Kokkadicholai", "Kolonnawa", "Kopay", "Kosgama", "Kosgoda", "Koslanda", "Kotagala", "Kotahena", "Kotikawatta", "Kottawa", "Kotte", "Kottegoda", "Kuliyapitiya", "Kundasale", "Kurunegala", "Kuruvita", "Lihiriyagama", "Lindula", "Loluwagoda", "Lunugamvehera", "Lunugala", "Lunugama", "Lunuvila", "Mabole", "Madahapola", "Madampe", "Madapatha", "Madawachchiya", "Madelgamuwa", "Madu Road", "Madulla", "Madulsima", "Mahagama", "Mahakumbukkadawala", "Mahanuwara", "Maharagama", "Mahawa", "Mahawela", "Mahiyanganaya", "Makandura", "Makewita", "Makola", "Malabe", "Mallakam", "Mandapam", "Mandawala", "Mankulam", "Mannar", "Mapalagama", "Maradana", "Marassana", "Marawila", "Maskeliya", "Matale", "Matara", "Mattegoda", "Matugama", "Mawanella", "Mawathagama", "Medawachchiya", "Meddegama", "Medirigiriya", "Meegahatenna", "Meegoda", "Meethirigala", "Melsiripura", "Middeniya", "Mihintale", "Millaniya", "Minuwangoda", "Mirigama", "Mirissa", "Monaragala", "Moragahahena", "Moratuwa", "Morawaka", "Mount Lavinia", "Mullaitivu", "Mulleriyawa New Town", "Mutur", "Mutwal", "Nagoda", "Nakkawatta", "Nalanda", "Nanu Oya", "Napawela", "Narahenpita", "Narammala", "Nattandiya", "Naula", "Nawalapitiya", "Nawana", "Negombo", "Nelliady", "Nikaweratiya", "Nilaveli", "Nildandahinna", "Nittambuwa", "Nochchiyagama", "Norwood", "Nugegoda", "Nuwara Eliya", "Oddamavadi", "Oddusuddan", "Ohiya", "Padaviya", "Padukka", "Paiyagala", "Palavi", "Pallebedda", "Pallekele", "Pallewela", "Pamanugama", "Panadura", "Pannala", "Pannipitiya", "Parakaduwa", "Parakramapura", "Paranthan", "Pasikudah", "Passara", "Pasyala", "Pelawatta", "Peliyagoda", "Pelmadulla", "Peradeniya", "Pettah", "Pilimathalawa", "Piliyandala", "Pitigala", "Point Pedro", "Polgahawela", "Polgasowita", "Polonnaruwa", "Polpithimukulana", "Poruwadanda", "Pottuvil", "Pugoda", "Pujapitiya", "Pulmoddai", "Punakarin", "Pundaluoya", "Pussellawa", "Puttalam", "Puwakpitiya", "Radawana", "Radawadunna", "Raddolugama", "Ragama", "Rajagiriya", "Rakwana", "Ramboda", "Rambukkana", "Ranala", "Ranna", "Rathgama", "Ratmalana", "Ratnapura", "Ridee", "Ruwanwella", "Sainthamaruthu", "Saliyapura", "Samanthurai", "Sandilipay", "Seeduwa", "Serunuwara", "Siddamulla", "Sigiriya", "Silavathurai", "Siyambalanduwa", "Slave Island", "Soranathota", "Sri Jayawardenepura Kotte", "Talaimannar", "Talawatugoda", "Talawakelle", "Tanamalwila", "Tangalle", "Teldeniya", "Tellippalai", "Thambuththegama", "Thanamalvila", "Thavady", "Theldeniya", "Thihagoda", "Thimbirigaskatuwa", "Tirunelveli", "Tissamaharama", "Trincomalee", "Tummodara", "Udagama", "Udappu", "Udathuthiripitiya", "Ududumbara", "Udugampola", "Udugoda", "Udumulla", "Uduvil", "Uggalboda", "Unawatuna", "Undugoda", "Unnichchai", "Uppuveli", "Urumpirai", "Uswetakeiyawa", "Vakaneri", "Valaichenai", "Valvettithurai", "Vavuniya", "Vidataltivu", "Veyangoda", "Wadduwa", "Waga", "Waikkal","Walasmulla", "Warakapola", "Wariyapola", "Watawala", "Watareka", "Wattala", "Wattegama", "Weligama", "Welikanda", "Welimada", "Wellawatta", "Wellawaya", "Wennappuwa","Weeraketiya", "Yakkala", "Yala", "Yatiyantota"].sort();

        // === UPDATED & MODIFIED: createTutorCard Function ===
        const createTutorCard = (tutor) => {
            // Handle both new array format ('subjects') and old string format ('subject')
            const subjectsArray = Array.isArray(tutor.subjects) 
                ? tutor.subjects 
                : (tutor.subject || '').split(',').map(s => s.trim()).filter(s => s);

            const subjectsHtml = subjectsArray.map(s => `<span class="tutor-tag">${s}</span>`).join('');
            
            const placeholderImageUrl = `https://placehold.co/100x100/e0e7ff/4f46e5?text=${(tutor.name || 'T').charAt(0)}`;

            const method = tutor.method ? tutor.method.charAt(0).toUpperCase() + tutor.method.slice(1) : 'N/A';
            const methodDisplay = method === 'Both' ? 'Online & In-Person' : (method === 'in-person' ? 'In-Person' : method);


            return `
                <div class="tutor-listing-card" data-tutor-id="${tutor.id}">
                    <div class="shine-effect"></div>
                    <div class="tutor-card-avatar-section">
                        <img src="${tutor.imageUrl || placeholderImageUrl}" alt="Tutor ${tutor.name}" class="tutor-listing-avatar">
                    </div>
                    <div class="tutor-card-content">
                        <div class="tutor-card-header">
                            <div>
                                <h3 class="tutor-name">${tutor.name || 'Unnamed Tutor'}</h3>
                            </div>
                            <p class="tutor-hourly-rate">Rs. ${tutor.rate || 'N/A'}/hr</p>
                        </div>
                        <div class="tutor-tags-list mb-3">${subjectsHtml}</div>
                        <div class="tutor-card-footer">
                            <div class="tutor-stats">
                                <span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>${tutor.hometown || 'Not set'}</span>
                                <span><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>${methodDisplay}</span>
                            </div>
                            <div class="tutor-actions">
                                <a href="TutorP.html?uid=${tutor.id}" class="btn btn-outline">View Profile</a>
                            </div>
                        </div>
                    </div>
                </div>`;
        };

        function apply3dCardEffect() {
            const cards = document.querySelectorAll('.tutor-listing-card');

            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    const rotateX = (y - centerY) / 15;
                    const rotateY = (centerX - x) / 15;
                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale3d(1.03, 1.03, 1.03)`;
                });

                card.addEventListener('mouseleave', () => {
                    card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale3d(1, 1, 1)';
                });
            });
        }

        const renderTutors = (localTutors, otherTutors) => {
            const loadingIndicator = document.getElementById('loading-indicator');
            if(loadingIndicator) loadingIndicator.style.display = 'none';

            tutorListingsSection.innerHTML = '';

            if (localTutors.length === 0 && otherTutors.length === 0) {
                tutorListingsSection.innerHTML = '<p class="text-center text-white text-lg py-10">No tutors found matching your criteria.</p>';
                return;
            }

            if (localTutors.length > 0) {
                let localHtml = '<h2 class="section-heading">Tutors in Your Area</h2><div class="tutors-grid">';
                localTutors.forEach(tutor => { localHtml += createTutorCard(tutor); });
                localHtml += '</div>';
                tutorListingsSection.insertAdjacentHTML('beforeend', localHtml);
            }

            if (otherTutors.length > 0) {
                let otherHtml = `<h2 class="section-heading mt-8">${localTutors.length > 0 ? 'Other' : ''} Available Tutors</h2><div class="tutors-grid">`;
                otherTutors.forEach(tutor => { otherHtml += createTutorCard(tutor); });
                otherHtml += '</div>';
                tutorListingsSection.insertAdjacentHTML('beforeend', otherHtml);
            }

            apply3dCardEffect();
        };

        // === UPDATED: applyFiltersAndSort Function ===
        const applyFiltersAndSort = () => {
            let filteredTutors = [...allTutors];
            const searchTerm = searchInput.value.toLowerCase().trim();
            
            if (searchTerm) {
                filteredTutors = filteredTutors.filter(tutor => {
                    const nameMatch = tutor.name && tutor.name.toLowerCase().includes(searchTerm);
                    // Check both new 'subjects' array and old 'subject' string
                    const subjectsArray = Array.isArray(tutor.subjects) ? tutor.subjects : (tutor.subject ? [tutor.subject] : []);
                    const subjectMatch = subjectsArray.some(s => s.toLowerCase().includes(searchTerm));
                    return nameMatch || subjectMatch;
                });
            }
            
            const selectedSubject = subjectFilter.getSelected();
            if (selectedSubject && selectedSubject[0] && selectedSubject[0] !== 'all') {
                const selectedSub = selectedSubject[0].toLowerCase();
                filteredTutors = filteredTutors.filter(tutor => {
                    // Check both new 'subjects' array and old 'subject' string
                    const subjectsArray = Array.isArray(tutor.subjects) ? tutor.subjects : (tutor.subject ? [tutor.subject] : []);
                    return subjectsArray.some(s => s.toLowerCase().includes(selectedSub));
                });
            }

            const selectedMethod = methodFilterEl.value;
            if (selectedMethod && selectedMethod !== 'any') {
                 filteredTutors = filteredTutors.filter(tutor => {
                    if (selectedMethod === 'both') return tutor.method === 'both';
                    if (selectedMethod === 'in-person') return tutor.method === 'in-person' || tutor.method === 'both';
                    return tutor.method === selectedMethod || tutor.method === 'both';
                });
            }

            const selectedMaxRate = parseFloat(maxRateEl.value);
            if (!isNaN(selectedMaxRate) && maxRateEl.value !== 'any') {
                filteredTutors = filteredTutors.filter(tutor =>
                    tutor.rate && parseFloat(tutor.rate) <= selectedMaxRate
                );
            }

            const userHometown = hometownFilter.getSelected();
            const localTutors = [];
            const otherTutors = [];
            const selectedTown = userHometown ? userHometown[0] : null;

            if (selectedTown) {
                filteredTutors.forEach(tutor => {
                    const isLocal = tutor.hometown === selectedTown || (Array.isArray(tutor.nearbyTowns) && tutor.nearbyTowns.includes(selectedTown));
                    if (isLocal) { localTutors.push(tutor); } else { otherTutors.push(tutor); }
                });
                renderTutors(localTutors, otherTutors);
            } else {
                renderTutors([], filteredTutors);
            }
            updateMap(filteredTutors, selectedTown);
        };
        
        // === UPDATED: initializeFilters Function ===
        const initializeFilters = () => {
            // Use the static, comprehensive list for subjects
            const subjectOptions = [{ text: 'All Subjects', value: 'all' }, ...sriLankaSubjects.map(s => ({ text: s, value: s }))];

            if (subjectFilter) subjectFilter.destroy();
            subjectFilter = new SlimSelect({
                select: '#filter-subject',
                settings: { placeholderText: 'Select Subject', allowDeselect: true },
                data: subjectOptions
            });

            new SlimSelect({
                select: '#filter-method',
                settings: { showSearch: false }
            });

            new SlimSelect({
                select: '#max-rate',
                settings: { showSearch: false }
            });
            
            if (hometownFilter) hometownFilter.destroy();
            hometownFilter = new SlimSelect({
                select: '#user-hometown',
                settings: { placeholderText: 'Select Your Town', allowDeselect: true },
                data: sriLankaTowns.map(t => ({text: t, value: t}))
            });
        };

        async function handleUserSession(user) {
            if (user) {
                const studentDocRef = doc(db, "students", user.uid);
                try {
                    const studentDocSnap = await getDoc(studentDocRef);
                    if (studentDocSnap.exists()) {
                        const studentData = studentDocSnap.data();
                        if (studentData.hometown && hometownFilter) {
                            hometownFilter.setSelected(studentData.hometown);
                        }
                    }
                } catch (error) { console.error("Error fetching student profile:", error); }
            }
        }

        function initMap() {
            map = L.map('map').setView([7.8731, 80.7718], 8);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
        }

        async function getCoordsForTown(townName) {
            if (townCoordsCache[townName]) return townCoordsCache[townName];
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?country=LK&city=${encodeURIComponent(townName)}&format=json&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    const coords = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                    townCoordsCache[townName] = coords;
                    return coords;
                }
                return null;
            } catch (error) { console.error("Error geocoding town:", townName, error); return null; }
        }

        async function updateMap(tutors, studentTown) {
            mapMarkers.forEach(marker => map.removeLayer(marker));
            mapMarkers = [];
            if (locationCircle) {
                map.removeLayer(locationCircle);
                locationCircle = null;
            }
            const studentIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
            const tutorIcon = L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });

            const tutorPromises = tutors.map(async (tutor) => {
                if (tutor.hometown) {
                    const tutorCoords = await getCoordsForTown(tutor.hometown);
                    if (tutorCoords) {
                        const tutorMarker = L.marker(tutorCoords, { icon: tutorIcon }).bindPopup(`<b>${tutor.name}</b><br>${tutor.hometown}`);
                        mapMarkers.push(tutorMarker);
                    }
                }
            });
            await Promise.all(tutorPromises);
            mapMarkers.forEach(marker => marker.addTo(map));

            if (studentTown) {
                const studentCoords = await getCoordsForTown(studentTown);
                if (studentCoords) {
                    const studentMarker = L.marker(studentCoords, { icon: studentIcon }).bindPopup('<b>Your Location</b><br>' + studentTown).addTo(map);
                    mapMarkers.push(studentMarker);
                    locationCircle = L.circle(studentCoords, { color: 'royalblue', fillColor: '#3498db', fillOpacity: 0.2, radius: 10000 }).addTo(map);
                    map.setView(studentCoords, 11);
                }
            } else {
                let bounds = L.latLngBounds(mapMarkers.map(marker => marker.getLatLng()));
                if (bounds.isValid()) {
                    map.fitBounds(bounds, { padding: [50, 50], maxZoom: 14 });
                } else {
                    map.setView([7.8731, 80.7718], 8);
                }
            }
        }

        async function fetchTutorsAndSetup() {
            try {
                initMap();
                initializeFilters(); // Initialize with static data first
                const tutorsCol = collection(db, "tutors");
                const q = query(tutorsCol, orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                allTutors = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                onAuthStateChanged(auth, (user) => {
                    handleUserSession(user).then(() => {
                        applyFiltersAndSort();
                    });
                });

                if (!getAuth().currentUser) {
                   applyFiltersAndSort();
                }
            } catch (error) {
                console.error("Error fetching tutors: ", error);
                tutorListingsSection.innerHTML = `<p class="text-center text-red-500 py-10">Error: Could not load tutor data. Please try again later.</p>`;
            }
        }

        searchButton.addEventListener('click', applyFiltersAndSort);
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                applyFiltersAndSort();
            }
        });

        document.addEventListener('DOMContentLoaded', fetchTutorsAndSetup);

    </script>
</body>
</html>